<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="关于程序与设计、黑客与画家  这里是 Masutangu 的个人博客。">
    <meta name="keywords"  content="Masutangu, Masutangu 的博客, Masutangu Blog, 博客, 个人网站, 互联网, 后端, Python, Go, C++">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="LevelDB 源码阅读（一） - Masutangu 的博客 | Masutangu Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="这篇文章主要记录 LevelDB 的重要模块、类以及方法。把读写操作和 Compaction 操作的代码串了一遍，并添加了小部分注释。

">
    
    <meta property="article:published_time" content="2017-06-23T15:53:23Z">
    
    
    
    <meta property="article:tag" content="源码阅读">
    
    
    <meta property="og:image" content="http://localhost:4000/img/avatar.jpg">
    <meta property="og:url" content="http://localhost:4000/2017/06/23/leveldb_1/">
    <meta property="og:site_name" content="Masutangu 的博客 | Masutangu Blog">
    
    <title>LevelDB 源码阅读（一） - Masutangu 的博客 | Masutangu Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2017/06/23/leveldb_1/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Masutangu</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">主页</a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a href="/about/">关于</a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="/archive/">归档</a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg');
        background: ;
    }

    
</style>

<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB" title="源码阅读">源码阅读</a>
                        
                    </div>
                    <h1>LevelDB 源码阅读（一）</h1>
                    
                    <h2 class="subheading"></h2>
                    <span class="meta">Posted by Masutangu on June 23, 2017</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<p>这篇文章主要记录 LevelDB 的重要模块、类以及方法。把读写操作和 Compaction 操作的代码串了一遍，并添加了小部分注释。</p>

<h1 id="模块">模块</h1>

<h3 id="log-文件">Log 文件</h3>

<p>客户端的写请求会先 append 到 Log 文件，成功后再写入到 Memtable。如果宕机可以通过 Log 文件来恢复 Memtable。</p>

<h3 id="memtable-和-immutable-memtable">Memtable 和 Immutable Memtable</h3>

<p>内存数据结构，基于跳表。客户端的读写请求都会由 Memtable 处理。 当 Memtable 占用的内存达到一定阈值，重新生成新的 Memtable 处理客户端请求。原来的 Memtable 转成 Immutable Memtable，等待归并到 SST 文件中。</p>

<h3 id="sst-文件">SST 文件</h3>

<p>落地到磁盘的存储文件。SST 分为不同的 level，具体参考<a href="https://github.com/google/leveldb/blob/master/doc/impl.md">文档</a>。</p>

<h3 id="manifest-文件">Manifest 文件</h3>

<p>Manifest 记录不同 level 的 SST 文件，包括每个 SST 文件的 key range、大小等 metadata。</p>

<h3 id="current-文件">Current 文件</h3>

<p>Current 记录了最新的 Manifest 文件。</p>

<h1 id="类成员变量">类成员变量</h1>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">DBImpl</span> <span class="o">:</span> <span class="k">public</span> <span class="n">DB</span> <span class="p">{</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="n">TableCache</span><span class="o">*</span> <span class="n">table_cache_</span><span class="p">;</span>
    <span class="n">MemTable</span><span class="o">*</span> <span class="n">mem_</span><span class="p">;</span>
    <span class="n">MemTable</span><span class="o">*</span> <span class="n">imm_</span><span class="p">;</span>
    <span class="n">WritableFile</span><span class="o">*</span> <span class="n">logfile_</span><span class="p">;</span>
    <span class="n">log</span><span class="o">::</span><span class="n">Writer</span><span class="o">*</span> <span class="n">log_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">Writer</span><span class="o">*&gt;</span> <span class="n">writers_</span><span class="p">;</span>
    <span class="n">VersionSet</span><span class="o">*</span> <span class="n">versions_</span><span class="p">;</span>

    <span class="c1">// Set of table files to protect from deletion because they are
</span>    <span class="c1">// part of ongoing compactions.
</span>    <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span> <span class="n">pending_outputs_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">MemTable</span> <span class="p">{</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="k">typedef</span> <span class="n">SkipList</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span><span class="p">,</span> <span class="n">KeyComparator</span><span class="o">&gt;</span> <span class="n">Table</span><span class="p">;</span>
    <span class="n">Arena</span> <span class="n">arena_</span><span class="p">;</span>  <span class="c1">// 内存池
</span>    <span class="n">Table</span> <span class="n">table_</span><span class="p">;</span>  <span class="c1">// 跳表
</span><span class="p">};</span>

<span class="k">struct</span> <span class="n">FileMetaData</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">refs</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">allowed_seek</span><span class="p">;</span>   <span class="c1">// seeks allowed until compaction
</span>  <span class="kt">uint64_t</span> <span class="n">number</span><span class="p">;</span>    <span class="c1">// ?? 
</span>  <span class="kt">uint64_t</span> <span class="n">file_size</span><span class="p">;</span>
  <span class="n">InternalKey</span> <span class="n">smallest</span><span class="p">;</span>
  <span class="n">InternalKey</span> <span class="n">largest</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">VersionEdit</span> <span class="p">{</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">uint64_t</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">DeletedFileSet</span><span class="p">;</span>

    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">InternalKey</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">compact_pointers_</span><span class="p">;</span>
    <span class="n">DeletedFileSet</span> <span class="n">deleted_files_</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">FileMetaData</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">new_files_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Version</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">Status</span> <span class="n">Get</span><span class="p">(</span><span class="k">const</span> <span class="n">ReadOptions</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">LookupKey</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">val</span><span class="p">,</span> 
               <span class="n">GetStats</span><span class="o">*</span> <span class="n">stats</span><span class="p">);</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="n">VersionSet</span><span class="o">*</span> <span class="n">vset_</span><span class="p">;</span>
    <span class="n">Version</span><span class="o">*</span> <span class="n">next_</span><span class="p">;</span>
    <span class="n">Version</span><span class="o">*</span> <span class="n">prev_</span><span class="p">;</span>

    <span class="c1">// list of files per level
</span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">FileMetaData</span><span class="o">*&gt;</span> <span class="n">files_</span><span class="p">[</span><span class="n">config</span><span class="o">::</span><span class="n">kNumLevels</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">TableCache</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">Status</span> <span class="n">Get</span><span class="p">(</span><span class="k">const</span> <span class="n">ReadOptions</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">file_number</span><span class="p">,</span> 
               <span class="kt">uint64_t</span> <span class="n">file_size</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">k</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> 
               <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handle_result</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span><span class="p">));</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="n">Cache</span><span class="o">*</span> <span class="n">cache_</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">VersionSet</span> <span class="p">{</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="n">TableCache</span><span class="o">*</span> <span class="k">const</span> <span class="n">table_cache_</span><span class="p">;</span>
    <span class="n">WritableFile</span><span class="o">*</span> <span class="n">descriptor_file_</span><span class="p">;</span>
    <span class="n">log</span><span class="o">::</span><span class="n">Writer</span><span class="o">*</span> <span class="n">descriptor_log_</span><span class="p">;</span>
    <span class="n">Version</span> <span class="n">dummy_versions_</span><span class="p">;</span>  <span class="c1">// Head of circurlar doubly-linked list of versions  
</span>    <span class="n">Version</span><span class="o">*</span> <span class="n">current_</span><span class="p">;</span>        <span class="c1">// == dummy_versions_.prev_
</span><span class="p">};</span>

<span class="k">class</span> <span class="nc">WriteBatch</span> <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="k">class</span> <span class="nc">Handler</span> <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="k">virtual</span> <span class="o">~</span><span class="n">Handler</span><span class="p">();</span>
        <span class="k">virtual</span> <span class="kt">void</span> <span class="n">Put</span><span class="p">(</span><span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">virtual</span> <span class="kt">void</span> <span class="n">Delete</span><span class="p">(</span><span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">};</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="k">friend</span> <span class="k">class</span> <span class="nc">WriteBatchInternal</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">req_</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">DBImpl</span><span class="o">::</span><span class="n">Writer</span> <span class="p">{</span>
  <span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
  <span class="n">WriteBatch</span><span class="o">*</span> <span class="n">batch</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">sync</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">done</span><span class="p">;</span>
  <span class="n">port</span><span class="o">::</span><span class="n">CondVar</span> <span class="n">cv</span><span class="p">;</span>

  <span class="n">expplicit</span> <span class="nf">Writer</span><span class="p">(</span><span class="n">port</span><span class="o">::</span><span class="n">Mutex</span><span class="o">*</span> <span class="n">mu</span><span class="p">)</span> <span class="o">:</span> <span class="n">cv</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">Compaction</span> <span class="p">{</span>
  <span class="k">private</span><span class="o">:</span>
    <span class="n">Version</span><span class="o">*</span> <span class="n">input_version_</span><span class="p">;</span>
    <span class="n">VersionEdit</span> <span class="n">edit_</span><span class="p">;</span>

    <span class="c1">// Each compaction reads inputs from "level_" and "level_+1"
</span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">FileMetaData</span><span class="o">*&gt;</span> <span class="n">inputs_</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>      <span class="c1">// The two sets of inputs
</span>
    <span class="c1">// State used to check for number of of overlapping grandparent files
</span>    <span class="c1">// (parent == level_ + 1, grandparent == level_ + 2)
</span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">FileMetaData</span><span class="o">*&gt;</span> <span class="n">grandparents_</span><span class="p">;</span>
    <span class="kt">size_t</span> <span class="n">grandparent_index_</span><span class="p">;</span>  <span class="c1">// Index in grandparent_starts_
</span>    <span class="kt">bool</span> <span class="n">seen_key_</span><span class="p">;</span>             <span class="c1">// Some output key has been seen
</span>    <span class="kt">int64_t</span> <span class="n">overlapped_bytes_</span><span class="p">;</span>  <span class="c1">// Bytes of overlap between current output
</span>                                <span class="c1">// and grandparent files
</span>
    <span class="c1">// level_ptrs_ holds indices into input_version_-&gt;levels_: our state
</span>    <span class="c1">// is that we are positioned at one of the file ranges for each
</span>    <span class="c1">// higher level than the ones involved in this compaction (i.e. for
</span>    <span class="c1">// all L &gt;= level_ + 2).
</span>    <span class="kt">size_t</span> <span class="n">level_ptrs_</span><span class="p">[</span><span class="n">config</span><span class="o">::</span><span class="n">kNumLevels</span><span class="p">];</span>
<span class="p">};</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<h1 id="主要操作">主要操作</h1>

<h3 id="读操作">读操作</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="n">Status</span> <span class="n">DBImpl</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="k">const</span> <span class="n">ReadOptions</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span>
                   <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span>
                   <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>

  <span class="n">MutexLock</span> <span class="n">l</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_</span><span class="p">);</span>
  <span class="n">MemTable</span><span class="o">*</span> <span class="n">mem</span> <span class="o">=</span> <span class="n">mem_</span><span class="p">;</span>
  <span class="n">MemTable</span><span class="o">*</span> <span class="n">imm</span> <span class="o">=</span> <span class="n">imm_</span><span class="p">;</span>
  <span class="n">Version</span><span class="o">*</span> <span class="n">current</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">current</span><span class="p">();</span>

  <span class="kt">bool</span> <span class="n">have_stat_update</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">Version</span><span class="o">::</span><span class="n">GetStats</span> <span class="n">stats</span><span class="p">;</span>

  <span class="c1">// Unlock while reading from files and memtables
</span>  <span class="p">{</span>
    <span class="n">mutex_</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
    <span class="c1">// First look in the memtable, then in the immutable memtable (if any).
</span>    <span class="n">LookupKey</span> <span class="n">lkey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">snapshot</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">lkey</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// 1）先在 MemTable 中查找
</span>      <span class="c1">// Done
</span>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">imm</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">imm</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">lkey</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// 2）再在 Imutable MemTable 中查找
</span>      <span class="c1">// Done
</span>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">lkey</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stats</span><span class="p">);</span>  <span class="c1">// 3) 最后在当前 Version 中查找
</span>      <span class="n">have_stat_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">mutex_</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// UpdateStats 减去 allowed_seeks，如果小于等于 0，则设置 file_to_compact_，准备 compaction
</span>  <span class="k">if</span> <span class="p">(</span><span class="n">have_stat_update</span> <span class="o">&amp;&amp;</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">UpdateStats</span><span class="p">(</span><span class="n">stats</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">MaybeScheduleCompaction</span><span class="p">();</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre></td><td class="rouge-code"><pre><span class="c1">// Version 类的 Get 方法
</span><span class="n">Status</span> <span class="n">Version</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="k">const</span> <span class="n">ReadOptions</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span>
                    <span class="k">const</span> <span class="n">LookupKey</span><span class="o">&amp;</span> <span class="n">k</span><span class="p">,</span>
                    <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">*</span> <span class="n">value</span><span class="p">,</span>
                    <span class="n">GetStats</span><span class="o">*</span> <span class="n">stats</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Slice</span> <span class="n">ikey</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">internal_key</span><span class="p">();</span>
  <span class="n">Slice</span> <span class="n">user_key</span> <span class="o">=</span> <span class="n">k</span><span class="p">.</span><span class="n">user_key</span><span class="p">();</span>
  <span class="k">const</span> <span class="n">Comparator</span><span class="o">*</span> <span class="n">ucmp</span> <span class="o">=</span> <span class="n">vset_</span><span class="o">-&gt;</span><span class="n">icmp_</span><span class="p">.</span><span class="n">user_comparator</span><span class="p">();</span>
  <span class="n">Status</span> <span class="n">s</span><span class="p">;</span>

  <span class="n">stats</span><span class="o">-&gt;</span><span class="n">seek_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">stats</span><span class="o">-&gt;</span><span class="n">seek_file_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">FileMetaData</span><span class="o">*</span> <span class="n">last_file_read</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">last_file_read_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="c1">// We can search level-by-level since entries never hop across
</span>  <span class="c1">// levels.  Therefore we are guaranteed that if we find data
</span>  <span class="c1">// in an smaller level, later levels are irrelevant.
</span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">FileMetaData</span><span class="o">*&gt;</span> <span class="n">tmp</span><span class="p">;</span>
  <span class="n">FileMetaData</span><span class="o">*</span> <span class="n">tmp2</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">::</span><span class="n">kNumLevels</span><span class="p">;</span> <span class="n">level</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">num_files</span> <span class="o">=</span> <span class="n">files_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">size</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">num_files</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

    <span class="c1">// 这里省略一大段代码 files 指向候选文件列表，num_files 为列表的长度。具体实现看源码
</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_files</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">last_file_read</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">seek_file</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// We have had more than one seek for this read.  Charge the 1st file.
</span>        <span class="c1">// last_file_read 保存的其实就是第一个查找未命中的文件，函数返回后会调用 UpdateStats 来减去 allowed_seeks
</span>        <span class="n">stats</span><span class="o">-&gt;</span><span class="n">seek_file</span> <span class="o">=</span> <span class="n">last_file_read</span><span class="p">;</span>
        <span class="n">stats</span><span class="o">-&gt;</span><span class="n">seek_file_level</span> <span class="o">=</span> <span class="n">last_file_read_level</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">FileMetaData</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
      <span class="n">last_file_read</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
      <span class="n">last_file_read_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>

      <span class="n">Saver</span> <span class="n">saver</span><span class="p">;</span>
      <span class="n">saver</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">kNotFound</span><span class="p">;</span>
      <span class="n">saver</span><span class="p">.</span><span class="n">ucmp</span> <span class="o">=</span> <span class="n">ucmp</span><span class="p">;</span>
      <span class="n">saver</span><span class="p">.</span><span class="n">user_key</span> <span class="o">=</span> <span class="n">user_key</span><span class="p">;</span>
      <span class="n">saver</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
      <span class="c1">// 从 TableCache 中读取文件内容
</span>      <span class="n">s</span> <span class="o">=</span> <span class="n">vset_</span><span class="o">-&gt;</span><span class="n">table_cache_</span><span class="o">-&gt;</span><span class="n">Get</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">file_size</span><span class="p">,</span>
                                   <span class="n">ikey</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saver</span><span class="p">,</span> <span class="n">SaveValue</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">saver</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="n">kNotFound</span><span class="p">:</span>
          <span class="k">break</span><span class="p">;</span>      <span class="c1">// Keep searching in other files
</span>        <span class="k">case</span> <span class="n">kFound</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">kDeleted</span><span class="p">:</span>
          <span class="n">s</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">NotFound</span><span class="p">(</span><span class="n">Slice</span><span class="p">());</span>  <span class="c1">// Use empty error message for speed
</span>          <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
        <span class="k">case</span> <span class="n">kCorrupt</span><span class="p">:</span>
          <span class="n">s</span> <span class="o">=</span> <span class="n">Status</span><span class="o">::</span><span class="n">Corruption</span><span class="p">(</span><span class="s">"corrupted key for "</span><span class="p">,</span> <span class="n">user_key</span><span class="p">);</span>
          <span class="k">return</span> <span class="n">s</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">Status</span><span class="o">::</span><span class="n">NotFound</span><span class="p">(</span><span class="n">Slice</span><span class="p">());</span>  <span class="c1">// Use an empty error message for speed
</span><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="n">Status</span> <span class="n">TableCache</span><span class="o">::</span><span class="n">Get</span><span class="p">(</span><span class="k">const</span> <span class="n">ReadOptions</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="kt">uint64_t</span> <span class="n">file_number</span><span class="p">,</span> 
                      <span class="kt">uint64_t</span> <span class="n">file_size</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">k</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span>
                      <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">saver</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">Cache</span><span class="o">::</span><span class="n">Handle</span><span class="o">*</span> <span class="n">handle</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="n">Status</span> <span class="n">s</span> <span class="o">=</span> <span class="n">FindTable</span><span class="p">(</span><span class="n">file_number</span><span class="p">,</span> <span class="n">file_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">handle</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">Table</span><span class="o">*</span> <span class="n">t</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">TableAndFile</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">cache_</span><span class="o">-&gt;</span><span class="n">Value</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">;</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">InternalGet</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">saver</span><span class="p">);</span>
    <span class="n">cache_</span><span class="o">-&gt;</span><span class="n">Release</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">s</span><span class="p">;</span>                        
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>查找顺序如下图：</p>

<p><img src="/assets/images/leveldb/illustration-1.png" width="800" /></p>

<h3 id="写操作">写操作</h3>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
</pre></td><td class="rouge-code"><pre><span class="n">Status</span> <span class="n">DB</span><span class="o">::</span><span class="n">Put</span><span class="p">(</span><span class="k">const</span> <span class="n">WriteOptions</span><span class="o">&amp;</span> <span class="n">opt</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">Slice</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">WriteBatch</span> <span class="n">batch</span><span class="p">;</span>
  <span class="n">batch</span><span class="p">.</span><span class="n">Put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
  <span class="k">return</span> <span class="n">Write</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">batch</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">Status</span> <span class="n">DBImpl</span><span class="o">::</span><span class="n">Write</span><span class="p">(</span><span class="k">const</span> <span class="n">WriteOptions</span><span class="o">&amp;</span> <span class="n">options</span><span class="p">,</span> <span class="n">WriteBatch</span><span class="o">*</span> <span class="n">my_batch</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">Writer</span> <span class="n">w</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_</span><span class="p">);</span>
  <span class="n">w</span><span class="p">.</span><span class="n">batch</span> <span class="o">=</span> <span class="n">my_batch</span><span class="p">;</span>
  <span class="n">w</span><span class="p">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">sync</span><span class="p">;</span>
  <span class="n">w</span><span class="p">.</span><span class="n">done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

  <span class="n">MutexLock</span> <span class="n">l</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex_</span><span class="p">);</span>
  <span class="n">writers_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>
  <span class="c1">// 生产者消费者模型
</span>  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">w</span><span class="p">.</span><span class="n">done</span> <span class="o">&amp;&amp;</span> <span class="o">&amp;</span><span class="n">w</span> <span class="o">!=</span> <span class="n">writers_</span><span class="p">.</span><span class="n">front</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">w</span><span class="p">.</span><span class="n">cv</span><span class="p">.</span><span class="n">Wait</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="c1">// 写操作有可能被合并处理，因此有可能取到的时候写入已经完成。完成的话直接返回
</span>  <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="p">.</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">w</span><span class="p">.</span><span class="n">status</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// May temporarily unlock and wait.
</span>  <span class="c1">// MakeRoomForWrite 判断是非需要归并 memtable
</span>  <span class="n">Status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">MakeRoomForWrite</span><span class="p">(</span><span class="n">my_batch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="kt">uint64_t</span> <span class="n">last_sequence</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">LastSequence</span><span class="p">();</span>
  <span class="n">Writer</span><span class="o">*</span> <span class="n">last_writer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">my_batch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// NULL batch is for compactions
</span>    <span class="n">WriteBatch</span><span class="o">*</span> <span class="n">updates</span> <span class="o">=</span> <span class="n">BuildBatchGroup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">last_writer</span><span class="p">);</span> <span class="c1">// 合并写操作
</span>    <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">SetSequence</span><span class="p">(</span><span class="n">updates</span><span class="p">,</span> <span class="n">last_sequence</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">last_sequence</span> <span class="o">+=</span> <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">Count</span><span class="p">(</span><span class="n">updates</span><span class="p">);</span>

    <span class="c1">// Add to log and apply to memtable.  We can release the lock
</span>    <span class="c1">// during this phase since &amp;w is currently responsible for logging
</span>    <span class="c1">// and protects against concurrent loggers and concurrent writes
</span>    <span class="c1">// into mem_.
</span>    <span class="p">{</span>
      <span class="n">mutex_</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">log_</span><span class="o">-&gt;</span><span class="n">AddRecord</span><span class="p">(</span><span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">Contents</span><span class="p">(</span><span class="n">updates</span><span class="p">));</span>
      <span class="kt">bool</span> <span class="n">sync_error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">options</span><span class="p">.</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">logfile_</span><span class="o">-&gt;</span><span class="n">Sync</span><span class="p">();</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">sync_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">InsertInto</span><span class="p">(</span><span class="n">updates</span><span class="p">,</span> <span class="n">mem_</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">mutex_</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">sync_error</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// The state of the log file is indeterminate: the log record we
</span>        <span class="c1">// just added may or may not show up when the DB is re-opened.
</span>        <span class="c1">// So we force the DB into a mode where all future writes fail.
</span>        <span class="n">RecordBackgroundError</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">updates</span> <span class="o">==</span> <span class="n">tmp_batch_</span><span class="p">)</span> <span class="n">tmp_batch_</span><span class="o">-&gt;</span><span class="n">Clear</span><span class="p">();</span>

    <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">SetLastSequence</span><span class="p">(</span><span class="n">last_sequence</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Writer</span><span class="o">*</span> <span class="n">ready</span> <span class="o">=</span> <span class="n">writers_</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
    <span class="n">writers_</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ready</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ready</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
      <span class="n">ready</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="n">ready</span><span class="o">-&gt;</span><span class="n">cv</span><span class="p">.</span><span class="n">Signal</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ready</span> <span class="o">==</span> <span class="n">last_writer</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Notify new head of write queue
</span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">writers_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">writers_</span><span class="p">.</span><span class="n">front</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">cv</span><span class="p">.</span><span class="n">Signal</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="c1">// REQUIRES: Writer list must be non-empty
// REQUIRES: First writer must have a non-NULL batch
// 尝试合并写操作
</span><span class="n">WriteBatch</span><span class="o">*</span> <span class="n">DBImpl</span><span class="o">::</span><span class="n">BuildBatchGroup</span><span class="p">(</span><span class="n">Writer</span><span class="o">**</span> <span class="n">last_writer</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">writers_</span><span class="p">.</span><span class="n">empty</span><span class="p">());</span>
  <span class="n">Writer</span><span class="o">*</span> <span class="n">first</span> <span class="o">=</span> <span class="n">writers_</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
  <span class="n">WriteBatch</span><span class="o">*</span> <span class="n">result</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">batch</span><span class="p">;</span>
  <span class="n">assert</span><span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>

  <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">ByteSize</span><span class="p">(</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">batch</span><span class="p">);</span>

  <span class="c1">// Allow the group to grow up to a maximum size, but if the
</span>  <span class="c1">// original write is small, limit the growth so we do not slow
</span>  <span class="c1">// down the small write too much.
</span>  <span class="kt">size_t</span> <span class="n">max_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">128</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">max_size</span> <span class="o">=</span> <span class="n">size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">128</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="o">*</span><span class="n">last_writer</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">Writer</span><span class="o">*&gt;::</span><span class="n">iterator</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">writers_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
  <span class="o">++</span><span class="n">iter</span><span class="p">;</span>  <span class="c1">// Advance past "first"
</span>  <span class="k">for</span> <span class="p">(;</span> <span class="n">iter</span> <span class="o">!=</span> <span class="n">writers_</span><span class="p">.</span><span class="n">end</span><span class="p">();</span> <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Writer</span><span class="o">*</span> <span class="n">w</span> <span class="o">=</span> <span class="o">*</span><span class="n">iter</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">first</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Do not include a sync write into a batch handled by a non-sync write.
</span>      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">batch</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">size</span> <span class="o">+=</span> <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">ByteSize</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">batch</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Do not make batch too big
</span>        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="c1">// Append to *result
</span>      <span class="c1">// 把合并的写请求保存在成员变量 tmp_batch_ 中，避免和调用者的写请求混淆在一起
</span>      <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">batch</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Switch to temporary batch instead of disturbing caller's batch
</span>        <span class="n">result</span> <span class="o">=</span> <span class="n">tmp_batch_</span><span class="p">;</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">Count</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
        <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">Append</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">batch</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">Append</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">batch</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">last_writer</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">Status</span> <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">InsertInto</span><span class="p">(</span><span class="k">const</span> <span class="n">WriteBatch</span><span class="o">*</span> <span class="n">b</span><span class="p">,</span>
                                      <span class="n">MemTable</span><span class="o">*</span> <span class="n">memtable</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MemTableInserter</span> <span class="n">inserter</span><span class="p">;</span>
  <span class="n">inserter</span><span class="p">.</span><span class="n">sequence_</span> <span class="o">=</span> <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">Sequence</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
  <span class="n">inserter</span><span class="p">.</span><span class="n">mem_</span> <span class="o">=</span> <span class="n">memtable</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">Iterate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">inserter</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="rouge-code"><pre><span class="n">Status</span> <span class="n">WriteBatch</span><span class="o">::</span><span class="n">Iterate</span><span class="p">(</span><span class="n">Handler</span><span class="o">*</span> <span class="n">handler</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">Slice</span> <span class="n">input</span><span class="p">(</span><span class="n">rep_</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">input</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">kHeader</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Status</span><span class="o">::</span><span class="n">Corruption</span><span class="p">(</span><span class="s">"malformed WriteBatch (too small)"</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="n">input</span><span class="p">.</span><span class="n">remove_prefix</span><span class="p">(</span><span class="n">kHeader</span><span class="p">);</span>
  <span class="n">Slice</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">input</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">found</span><span class="o">++</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">input</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="n">input</span><span class="p">.</span><span class="n">remove_prefix</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">tag</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">kTypeValue</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">GetLengthPrefixedSlice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
            <span class="n">GetLengthPrefixedSlice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">handler</span><span class="o">-&gt;</span><span class="n">Put</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">Status</span><span class="o">::</span><span class="n">Corruption</span><span class="p">(</span><span class="s">"bad WriteBatch Put"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="n">kTypeDeletion</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">GetLengthPrefixedSlice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">handler</span><span class="o">-&gt;</span><span class="n">Delete</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="n">Status</span><span class="o">::</span><span class="n">Corruption</span><span class="p">(</span><span class="s">"bad WriteBatch Delete"</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">Status</span><span class="o">::</span><span class="n">Corruption</span><span class="p">(</span><span class="s">"unknown WriteBatch tag"</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">!=</span> <span class="n">WriteBatchInternal</span><span class="o">::</span><span class="n">Count</span><span class="p">(</span><span class="k">this</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Status</span><span class="o">::</span><span class="n">Corruption</span><span class="p">(</span><span class="s">"WriteBatch has wrong count"</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Status</span><span class="o">::</span><span class="n">OK</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="compaction">Compaction</h3>

<p>Compaction 触发时机：</p>

<ul>
  <li>Immutable MemTable 不为空</li>
  <li>指定了 Manual Compaction</li>
  <li>VersionSet NeedsCompaction 返回 True
    <ul>
      <li><code class="highlighter-rouge">compaction_score_</code> 大于 1</li>
      <li><code class="highlighter-rouge">file_to_compact_</code> 不为空</li>
    </ul>
  </li>
</ul>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">DBImpl</span><span class="o">::</span><span class="n">MaybeScheduleCompaction</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mutex_</span><span class="p">.</span><span class="n">AssertHeld</span><span class="p">();</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">bg_compaction_scheduled_</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Already scheduled
</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shutting_down_</span><span class="p">.</span><span class="n">Acquire_Load</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// DB is being deleted; no more background compactions
</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bg_error_</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Already got an error; no more changes
</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">imm_</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
             <span class="n">manual_compaction_</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
             <span class="o">!</span><span class="n">versions_</span><span class="o">-&gt;</span><span class="n">NeedsCompaction</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// No work to be done
</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">bg_compaction_scheduled_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">env_</span><span class="o">-&gt;</span><span class="n">Schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DBImpl</span><span class="o">::</span><span class="n">BGWork</span><span class="p">,</span> <span class="k">this</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">VersionSet</span><span class="o">::</span><span class="n">NeedsCompaction</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="n">Version</span><span class="o">*</span> <span class="n">v</span> <span class="o">=</span> <span class="n">current_</span><span class="p">;</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">compaction_score_</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">file_to_compact_</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>compaction_score_ 的计算如下：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">VersionSet</span><span class="o">::</span><span class="n">Finalize</span><span class="p">(</span><span class="n">Version</span><span class="o">*</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Precomputed best level for next compaction
</span>  <span class="kt">int</span> <span class="n">best_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">best_score</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">level</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">::</span><span class="n">kNumLevels</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">level</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">double</span> <span class="n">score</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// We treat level-0 specially by bounding the number of files
</span>      <span class="c1">// instead of number of bytes for two reasons:
</span>      <span class="c1">//
</span>      <span class="c1">// (1) With larger write-buffer sizes, it is nice not to do too
</span>      <span class="c1">// many level-0 compactions.
</span>      <span class="c1">//
</span>      <span class="c1">// (2) The files in level-0 are merged on every read and
</span>      <span class="c1">// therefore we wish to avoid too many files when the individual
</span>      <span class="c1">// file size is small (perhaps because of a small write-buffer
</span>      <span class="c1">// setting, or very high compression ratios, or lots of
</span>      <span class="c1">// overwrites/deletions).
</span>      <span class="n">score</span> <span class="o">=</span> <span class="n">v</span><span class="o">-&gt;</span><span class="n">files_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">size</span><span class="p">()</span> <span class="o">/</span>
          <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">config</span><span class="o">::</span><span class="n">kL0_CompactionTrigger</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Compute the ratio of current size to size limit.
</span>      <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">level_bytes</span> <span class="o">=</span> <span class="n">TotalFileSize</span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">files_</span><span class="p">[</span><span class="n">level</span><span class="p">]);</span>
      <span class="n">score</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">level_bytes</span><span class="p">)</span> <span class="o">/</span> <span class="n">MaxBytesForLevel</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">score</span> <span class="o">&gt;</span> <span class="n">best_score</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">best_level</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
      <span class="n">best_score</span> <span class="o">=</span> <span class="n">score</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">v</span><span class="o">-&gt;</span><span class="n">compaction_level_</span> <span class="o">=</span> <span class="n">best_level</span><span class="p">;</span>
  <span class="n">v</span><span class="o">-&gt;</span><span class="n">compaction_score_</span> <span class="o">=</span> <span class="n">best_score</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>file_to_compact_ 则是由 allowed_seeks 来控制。从下面代码的注释可知 25 次 seek 的开销和一次 compaction 的开销差不多。allowed_seeks 可以理解为文件剩余查找次数，每次查找失败allowed_seeks 就会减 1。当 allowed_seeks 小于等于 0，意味着应该启动 compaction 来减少查找未命中带来的 seek 的开销了：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre></td><td class="rouge-code"><pre><span class="kt">bool</span> <span class="n">Version</span><span class="o">::</span><span class="n">UpdateStats</span><span class="p">(</span><span class="k">const</span> <span class="n">GetStats</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">FileMetaData</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">seek_file</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">f</span><span class="o">-&gt;</span><span class="n">allowed_seeks</span><span class="o">--</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">allowed_seeks</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">file_to_compact_</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">file_to_compact_</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
      <span class="n">file_to_compact_level_</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">seek_file_level</span><span class="p">;</span>
      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Apply all of the edits in *edit to the current state.
</span><span class="kt">void</span> <span class="n">Builder</span><span class="o">::</span><span class="n">Apply</span><span class="p">(</span><span class="n">VersionEdit</span><span class="o">*</span> <span class="n">edit</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Update compaction pointers
</span>  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">edit</span><span class="o">-&gt;</span><span class="n">compact_pointers_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">edit</span><span class="o">-&gt;</span><span class="n">compact_pointers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">;</span>
    <span class="n">vset_</span><span class="o">-&gt;</span><span class="n">compact_pointer_</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">=</span>
        <span class="n">edit</span><span class="o">-&gt;</span><span class="n">compact_pointers_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">.</span><span class="n">Encode</span><span class="p">().</span><span class="n">ToString</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// Delete files
</span>  <span class="k">const</span> <span class="n">VersionEdit</span><span class="o">::</span><span class="n">DeletedFileSet</span><span class="o">&amp;</span> <span class="n">del</span> <span class="o">=</span> <span class="n">edit</span><span class="o">-&gt;</span><span class="n">deleted_files_</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">VersionEdit</span><span class="o">::</span><span class="n">DeletedFileSet</span><span class="o">::</span><span class="n">const_iterator</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">del</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
        <span class="n">iter</span> <span class="o">!=</span> <span class="n">del</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
        <span class="o">++</span><span class="n">iter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">uint64_t</span> <span class="n">number</span> <span class="o">=</span> <span class="n">iter</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">;</span>
    <span class="n">levels_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">deleted_files</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">number</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="c1">// Add new files
</span>  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">edit</span><span class="o">-&gt;</span><span class="n">new_files_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">edit</span><span class="o">-&gt;</span><span class="n">new_files_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">;</span>
    <span class="n">FileMetaData</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FileMetaData</span><span class="p">(</span><span class="n">edit</span><span class="o">-&gt;</span><span class="n">new_files_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">);</span>
    <span class="n">f</span><span class="o">-&gt;</span><span class="n">refs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="c1">// We arrange to automatically compact this file after
</span>    <span class="c1">// a certain number of seeks.  Let's assume:
</span>    <span class="c1">//   (1) One seek costs 10ms
</span>    <span class="c1">//   (2) Writing or reading 1MB costs 10ms (100MB/s)
</span>    <span class="c1">//   (3) A compaction of 1MB does 25MB of IO:
</span>    <span class="c1">//         1MB read from this level
</span>    <span class="c1">//         10-12MB read from next level (boundaries may be misaligned)
</span>    <span class="c1">//         10-12MB written to next level
</span>    <span class="c1">// This implies that 25 seeks cost the same as the compaction
</span>    <span class="c1">// of 1MB of data.  I.e., one seek costs approximately the
</span>    <span class="c1">// same as the compaction of 40KB of data.  We are a little
</span>    <span class="c1">// conservative and allow approximately one seek for every 16KB
</span>    <span class="c1">// of data before triggering a compaction.
</span>    <span class="n">f</span><span class="o">-&gt;</span><span class="n">allowed_seeks</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">file_size</span> <span class="o">/</span> <span class="mi">16384</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">allowed_seeks</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">allowed_seeks</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

    <span class="n">levels_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">deleted_files</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
    <span class="n">levels_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">added_files</span><span class="o">-&gt;</span><span class="n">insert</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>看看 Compaction 做了哪些工作：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="n">DBImpl</span><span class="o">::</span><span class="n">BackgroundCompaction</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">mutex_</span><span class="p">.</span><span class="n">AssertHeld</span><span class="p">();</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">imm_</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">CompactMemTable</span><span class="p">();</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 这里去掉了 manual compaction 的代码 不关心
</span>  <span class="n">Compaction</span><span class="o">*</span> <span class="n">c</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">PickCompaction</span><span class="p">();</span>

  <span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Nothing to do
</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">IsTrivialMove</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Move file to next level
</span>    <span class="c1">// IsTrivialMove 返回 True 则直接将文件移入 level + 1 层即可
</span>    <span class="n">assert</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">num_input_files</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">FileMetaData</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">edit</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">DeleteFile</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">(),</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">edit</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">AddFile</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">file_size</span><span class="p">,</span>
                       <span class="n">f</span><span class="o">-&gt;</span><span class="n">smallest</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">largest</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">LogAndApply</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">edit</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">mutex_</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">RecordBackgroundError</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">CompactionState</span><span class="o">*</span> <span class="n">compact</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CompactionState</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">DoCompactionWork</span><span class="p">(</span><span class="n">compact</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">RecordBackgroundError</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">CleanupCompaction</span><span class="p">(</span><span class="n">compact</span><span class="p">);</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">ReleaseInputs</span><span class="p">();</span>
    <span class="n">DeleteObsoleteFiles</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">delete</span> <span class="n">c</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Done
</span>  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">shutting_down_</span><span class="p">.</span><span class="n">Acquire_Load</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// Ignore compaction errors found during shutting down
</span>  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">Log</span><span class="p">(</span><span class="n">options_</span><span class="p">.</span><span class="n">info_log</span><span class="p">,</span>
        <span class="s">"Compaction error: %s"</span><span class="p">,</span> <span class="n">status</span><span class="p">.</span><span class="n">ToString</span><span class="p">().</span><span class="n">c_str</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
</pre></td><td class="rouge-code"><pre><span class="n">Compaction</span><span class="o">*</span> <span class="n">VersionSet</span><span class="o">::</span><span class="n">PickCompaction</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">Compaction</span><span class="o">*</span> <span class="n">c</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">level</span><span class="p">;</span>

  <span class="c1">// We prefer compactions triggered by too much data in a level over
</span>  <span class="c1">// the compactions triggered by seeks.
</span>  <span class="c1">// 判断是 size_compaction 还是 seek_compaction
</span>  <span class="k">const</span> <span class="kt">bool</span> <span class="n">size_compaction</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_</span><span class="o">-&gt;</span><span class="n">compaction_score_</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">);</span>
  <span class="k">const</span> <span class="kt">bool</span> <span class="n">seek_compaction</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_</span><span class="o">-&gt;</span><span class="n">file_to_compact_</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">size_compaction</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">current_</span><span class="o">-&gt;</span><span class="n">compaction_level_</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">level</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">level</span><span class="o">+</span><span class="mi">1</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">::</span><span class="n">kNumLevels</span><span class="p">);</span>
    <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Compaction</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>

    <span class="c1">// Pick the first file that comes after compact_pointer_[level]
</span>    <span class="c1">// compact_pointer_[level] 记录上次 compact 时最大的 key
</span>    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">current_</span><span class="o">-&gt;</span><span class="n">files_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">FileMetaData</span><span class="o">*</span> <span class="n">f</span> <span class="o">=</span> <span class="n">current_</span><span class="o">-&gt;</span><span class="n">files_</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">compact_pointer_</span><span class="p">[</span><span class="n">level</span><span class="p">].</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span>
          <span class="n">icmp_</span><span class="p">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">largest</span><span class="p">.</span><span class="n">Encode</span><span class="p">(),</span> <span class="n">compact_pointer_</span><span class="p">[</span><span class="n">level</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
      <span class="c1">// Wrap-around to the beginning of the key space
</span>      <span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">current_</span><span class="o">-&gt;</span><span class="n">files_</span><span class="p">[</span><span class="n">level</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">seek_compaction</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">level</span> <span class="o">=</span> <span class="n">current_</span><span class="o">-&gt;</span><span class="n">file_to_compact_level_</span><span class="p">;</span>
    <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Compaction</span><span class="p">(</span><span class="n">level</span><span class="p">);</span>
    <span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">push_back</span><span class="p">(</span><span class="n">current_</span><span class="o">-&gt;</span><span class="n">file_to_compact_</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">c</span><span class="o">-&gt;</span><span class="n">input_version_</span> <span class="o">=</span> <span class="n">current_</span><span class="p">;</span>
  <span class="n">c</span><span class="o">-&gt;</span><span class="n">input_version_</span><span class="o">-&gt;</span><span class="n">Ref</span><span class="p">();</span>

  <span class="c1">// Files in level 0 may overlap each other, so pick up all overlapping ones
</span>  <span class="k">if</span> <span class="p">(</span><span class="n">level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">InternalKey</span> <span class="n">smallest</span><span class="p">,</span> <span class="n">largest</span><span class="p">;</span>
    <span class="n">GetRange</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">smallest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">largest</span><span class="p">);</span>
    <span class="c1">// Note that the next call will discard the file we placed in
</span>    <span class="c1">// c-&gt;inputs_[0] earlier and replace it with an overlapping set
</span>    <span class="c1">// which will include the picked file.
</span>    <span class="n">current_</span><span class="o">-&gt;</span><span class="n">GetOverlappingInputs</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smallest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">largest</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">assert</span><span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">inputs_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">empty</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="c1">// 填充 level + 1 的文件，更新 compact_pointer_ 
</span>  <span class="n">SetupOtherInputs</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

  <span class="k">return</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>IsTrivialMove 判断能否直接将文件移入 level + 1 层：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="kt">bool</span> <span class="n">Compaction</span><span class="o">::</span><span class="n">IsTrivialMove</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span>
  <span class="c1">// Avoid a move if there is lots of overlapping grandparent data.
</span>  <span class="c1">// Otherwise, the move could create a parent file that will require
</span>  <span class="c1">// a very expensive merge later on.
</span>  <span class="k">return</span> <span class="p">(</span><span class="n">num_input_files</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
          <span class="n">num_input_files</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
          <span class="n">TotalFileSize</span><span class="p">(</span><span class="n">grandparents_</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">kMaxGrandParentOverlapBytes</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>具体的合并操作在 DoCompactionWork 方法：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
</pre></td><td class="rouge-code"><pre><span class="n">Status</span> <span class="n">DBImpl</span><span class="o">::</span><span class="n">DoCompactionWork</span><span class="p">(</span><span class="n">CompactionState</span><span class="o">*</span> <span class="n">compact</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">snapshots_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">compact</span><span class="o">-&gt;</span><span class="n">smallest_snapshot</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">LastSequence</span><span class="p">();</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">compact</span><span class="o">-&gt;</span><span class="n">smallest_snapshot</span> <span class="o">=</span> <span class="n">snapshots_</span><span class="p">.</span><span class="n">oldest</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">number_</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Release mutex while we're actually doing the compaction work
</span>  <span class="n">mutex_</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>

  <span class="n">Iterator</span><span class="o">*</span> <span class="n">input</span> <span class="o">=</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">MakeInputIterator</span><span class="p">(</span><span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="p">);</span>
  <span class="n">input</span><span class="o">-&gt;</span><span class="n">SeekToFirst</span><span class="p">();</span>
  <span class="n">Status</span> <span class="n">status</span><span class="p">;</span>
  <span class="n">ParsedInternalKey</span> <span class="n">ikey</span><span class="p">;</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">current_user_key</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">has_current_user_key</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
  <span class="n">SequenceNumber</span> <span class="n">last_sequence_for_key</span> <span class="o">=</span> <span class="n">kMaxSequenceNumber</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(;</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">Valid</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">shutting_down_</span><span class="p">.</span><span class="n">Acquire_Load</span><span class="p">();</span> <span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Prioritize immutable compaction work
</span>    <span class="k">if</span> <span class="p">(</span><span class="n">has_imm_</span><span class="p">.</span><span class="n">NoBarrier_Load</span><span class="p">()</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">mutex_</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">imm_</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">CompactMemTable</span><span class="p">();</span>  <span class="c1">// 总是优先处理 CompactMemTable 避免阻塞 MemTable 的写入
</span>        <span class="n">bg_cv_</span><span class="p">.</span><span class="n">SignalAll</span><span class="p">();</span>  <span class="c1">// Wakeup MakeRoomForWrite() if necessary
</span>      <span class="p">}</span>
      <span class="n">mutex_</span><span class="p">.</span><span class="n">Unlock</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="n">Slice</span> <span class="n">key</span> <span class="o">=</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">ShouldStopBefore</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">compact</span><span class="o">-&gt;</span><span class="n">builder</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">FinishCompactionOutputFile</span><span class="p">(</span><span class="n">compact</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Handle key/value, add to state, etc.
</span>    <span class="kt">bool</span> <span class="n">drop</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ParseInternalKey</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ikey</span><span class="p">))</span> <span class="p">{</span>
      <span class="c1">// Do not hide error keys
</span>      <span class="n">current_user_key</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
      <span class="n">has_current_user_key</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
      <span class="n">last_sequence_for_key</span> <span class="o">=</span> <span class="n">kMaxSequenceNumber</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_current_user_key</span> <span class="o">||</span>
          <span class="n">user_comparator</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">Compare</span><span class="p">(</span><span class="n">ikey</span><span class="p">.</span><span class="n">user_key</span><span class="p">,</span>
                                     <span class="n">Slice</span><span class="p">(</span><span class="n">current_user_key</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// First occurrence of this user key
</span>        <span class="n">current_user_key</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">ikey</span><span class="p">.</span><span class="n">user_key</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">ikey</span><span class="p">.</span><span class="n">user_key</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
        <span class="n">has_current_user_key</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">last_sequence_for_key</span> <span class="o">=</span> <span class="n">kMaxSequenceNumber</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span><span class="n">last_sequence_for_key</span> <span class="o">&lt;=</span> <span class="n">compact</span><span class="o">-&gt;</span><span class="n">smallest_snapshot</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Hidden by an newer entry for same user key
</span>        <span class="n">drop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>    <span class="c1">// (A)
</span>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ikey</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">kTypeDeletion</span> <span class="o">&amp;&amp;</span>
                 <span class="n">ikey</span><span class="p">.</span><span class="n">sequence</span> <span class="o">&lt;=</span> <span class="n">compact</span><span class="o">-&gt;</span><span class="n">smallest_snapshot</span> <span class="o">&amp;&amp;</span>
                 <span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">IsBaseLevelForKey</span><span class="p">(</span><span class="n">ikey</span><span class="p">.</span><span class="n">user_key</span><span class="p">))</span> <span class="p">{</span>
        <span class="c1">// For this user key:
</span>        <span class="c1">// (1) there is no data in higher levels
</span>        <span class="c1">// (2) data in lower levels will have larger sequence numbers
</span>        <span class="c1">// (3) data in layers that are being compacted here and have
</span>        <span class="c1">//     smaller sequence numbers will be dropped in the next
</span>        <span class="c1">//     few iterations of this loop (by rule (A) above).
</span>        <span class="c1">// Therefore this deletion marker is obsolete and can be dropped.
</span>        <span class="c1">// 如果高层还有记录，则 kTypeDeletion 标记不能丢掉。
</span>        <span class="c1">// smallest_snapshot 主要是为了快照功能服务
</span>        <span class="c1">// 但 ikey.sequence &lt;= compact-&gt;smallest_snapshot 这个判断没看懂
</span>        <span class="n">drop</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
      <span class="p">}</span>

      <span class="n">last_sequence_for_key</span> <span class="o">=</span> <span class="n">ikey</span><span class="p">.</span><span class="n">sequence</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">drop</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Open output file if necessary
</span>      <span class="k">if</span> <span class="p">(</span><span class="n">compact</span><span class="o">-&gt;</span><span class="n">builder</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">OpenCompactionOutputFile</span><span class="p">(</span><span class="n">compact</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">compact</span><span class="o">-&gt;</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">NumEntries</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">compact</span><span class="o">-&gt;</span><span class="n">current_output</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">smallest</span><span class="p">.</span><span class="n">DecodeFrom</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="n">compact</span><span class="o">-&gt;</span><span class="n">current_output</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">largest</span><span class="p">.</span><span class="n">DecodeFrom</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
      <span class="n">compact</span><span class="o">-&gt;</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">Add</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">());</span>

      <span class="c1">// Close output file if it is big enough
</span>      <span class="k">if</span> <span class="p">(</span><span class="n">compact</span><span class="o">-&gt;</span><span class="n">builder</span><span class="o">-&gt;</span><span class="n">FileSize</span><span class="p">()</span> <span class="o">&gt;=</span>
          <span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">MaxOutputFileSize</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">FinishCompactionOutputFile</span><span class="p">(</span><span class="n">compact</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>  <span class="c1">// 输出新的 SST 文件
</span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">input</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="c1">// 中间省略一坨代码
</span>
  <span class="n">mutex_</span><span class="p">.</span><span class="n">Lock</span><span class="p">();</span>
  <span class="n">stats_</span><span class="p">[</span><span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">Add</span><span class="p">(</span><span class="n">stats</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">.</span><span class="n">ok</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">InstallCompactionResults</span><span class="p">(</span><span class="n">compact</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>最后调用 InstallCompactionResults，记录版本变化：</p>

<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="n">Status</span> <span class="n">DBImpl</span><span class="o">::</span><span class="n">InstallCompactionResults</span><span class="p">(</span><span class="n">CompactionState</span><span class="o">*</span> <span class="n">compact</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">mutex_</span><span class="p">.</span><span class="n">AssertHeld</span><span class="p">();</span>
  <span class="n">Log</span><span class="p">(</span><span class="n">options_</span><span class="p">.</span><span class="n">info_log</span><span class="p">,</span>  <span class="s">"Compacted %d@%d + %d@%d files =&gt; %lld bytes"</span><span class="p">,</span>
      <span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">num_input_files</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">(),</span>
      <span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">num_input_files</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
      <span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
      <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">long</span> <span class="kt">long</span><span class="o">&gt;</span><span class="p">(</span><span class="n">compact</span><span class="o">-&gt;</span><span class="n">total_bytes</span><span class="p">));</span>

  <span class="c1">// Add compaction outputs
</span>  <span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">AddInputDeletions</span><span class="p">(</span><span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">edit</span><span class="p">());</span>
  <span class="k">const</span> <span class="kt">int</span> <span class="n">level</span> <span class="o">=</span> <span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">();</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">compact</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">CompactionState</span><span class="o">::</span><span class="n">Output</span><span class="o">&amp;</span> <span class="n">out</span> <span class="o">=</span> <span class="n">compact</span><span class="o">-&gt;</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">edit</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">AddFile</span><span class="p">(</span>
        <span class="n">level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">out</span><span class="p">.</span><span class="n">number</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="n">file_size</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="n">smallest</span><span class="p">,</span> <span class="n">out</span><span class="p">.</span><span class="n">largest</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">versions_</span><span class="o">-&gt;</span><span class="n">LogAndApply</span><span class="p">(</span><span class="n">compact</span><span class="o">-&gt;</span><span class="n">compaction</span><span class="o">-&gt;</span><span class="n">edit</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">mutex_</span><span class="p">);</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2017/02/25/linker-loader-library-note/" data-toggle="tooltip" data-placement="top" title="链接和装载">
                        Previous<br>
                        <span>链接和装载</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2017/11/01/state-machine/" data-toggle="tooltip" data-placement="top" title="游戏开发之状态机">
                        Next<br>
                        <span>游戏开发之状态机</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        </a>
        
        
                <a data-sort="0058" 
                    href="/archive/?tag=%E4%B8%AA%E4%BA%BA%E9%A1%B9%E7%9B%AE"
                    title="个人项目"
                    rel="4">个人项目</a>
        
                <a data-sort="0040" 
                    href="/archive/?tag=%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0"
                    title="读书笔记"
                    rel="22">读书笔记</a>
        
                <a data-sort="0047" 
                    href="/archive/?tag=%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"
                    title="源码阅读"
                    rel="15">源码阅读</a>
        
                <a data-sort="0055" 
                    href="/archive/?tag=%E5%B7%A5%E4%BD%9C"
                    title="工作"
                    rel="7">工作</a>
        
                <a data-sort="0059" 
                    href="/archive/?tag=%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80"
                    title="编程语言"
                    rel="3">编程语言</a>
        
                <a data-sort="0059" 
                    href="/archive/?tag=%E9%9A%8F%E7%AC%94"
                    title="随笔"
                    rel="3">随笔</a>
        
                <a data-sort="0060" 
                    href="/archive/?tag=%E4%BC%98%E5%8C%96%26%E9%87%8D%E6%9E%84"
                    title="优化&重构"
                    rel="2">优化&重构</a>
        
                <a data-sort="0060" 
                    href="/archive/?tag=%E6%95%B0%E6%8D%AE%E5%BA%93"
                    title="数据库"
                    rel="2">数据库
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="https://blog.zhiheng.io">onlyice</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  
  
  
  <li>
    <a target="_blank" href="https://github.com/masutangu">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  
  <li>
    <a target="_blank" href="https://www.instagram.com/masutanguu">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Masutangu 2018
                    <br>
                    Powered by <a href="http://huangxuan.me">Hux Blog</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->





<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-77236140-1';
    var _gaDomain = 'masutangu.com';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->



<!-- Multi-Lingual -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
