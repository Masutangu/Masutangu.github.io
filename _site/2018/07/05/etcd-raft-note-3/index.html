<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="关于程序与设计、黑客与画家  这里是 Masutangu 的个人博客。">
    <meta name="keywords"  content="Masutangu, Masutangu 的博客, Masutangu Blog, 博客, 个人网站, 互联网, 后端, Python, Go, C++">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="etcd-raft 源码学习笔记（Linearizable Read 之 ReadIndx） - Masutangu 的博客 | Masutangu Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="这篇文章介绍 etcd-raft 如何实现 linearizable read（linearizable read 简单的说就是不返回 stale 数据，具体可以看这篇文章 《Strong consistency models》）。

">
    
    <meta property="article:published_time" content="2018-07-05T13:46:43Z">
    
    
    
    <meta property="article:tag" content="源码阅读">
    
    
    <meta property="og:image" content="http://localhost:4000/img/avatar.jpg">
    <meta property="og:url" content="http://localhost:4000/2018/07/05/etcd-raft-note-3/">
    <meta property="og:site_name" content="Masutangu 的博客 | Masutangu Blog">
    
    <title>etcd-raft 源码学习笔记（Linearizable Read 之 ReadIndx） - Masutangu 的博客 | Masutangu Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2018/07/05/etcd-raft-note-3/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Masutangu</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">主页</a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a href="/about/">关于</a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="/archive/">归档</a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg');
        background: ;
    }

    
</style>

<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB" title="源码阅读">源码阅读</a>
                        
                    </div>
                    <h1>etcd-raft 源码学习笔记（Linearizable Read 之 ReadIndx）</h1>
                    
                    <h2 class="subheading"></h2>
                    <span class="meta">Posted by Masutangu on July 5, 2018</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<p>这篇文章介绍 etcd-raft 如何实现 linearizable read（linearizable read 简单的说就是不返回 stale 数据，具体可以看这篇文章 <a href="https://aphyr.com/posts/313-strong-consistency-models">《Strong consistency models》</a>）。</p>

<p>raft 论文第 8 节阐述了思路：</p>

<blockquote>
  <p>Read-only operations can be handled without writing anything into the log. However, with no additional measures, this would run the risk of returning stale data, since the leader responding to the request might have been superseded by a newer leader of which it is unaware. Linearizable reads must not return stale data, and Raft needs two extra precautions to guarantee this without using the log. First, a leader must have the latest information on which entries are committed. The Leader Completeness Property guarantees that a leader has all committed entries, but at the start of its term, it may not know which those are. To find out, it needs to commit an entry from its term. Raft handles this by having each leader commit a blank no-op entry into the log at the start of its term. Second, a leader must check whether it has been deposed before processing a read-only request (its information may be stale if a more recent leader has been elected). Raft handles this by having the leader exchange heartbeat messages with a majority of the cluster before responding to read-only requests.</p>
</blockquote>

<p>在收到读请求时，leader 节点保存下当前的 commit index，并往 peers 发送心跳。如果确定该节点依然是 leader，则只需要等到该 commit index 的 log entry 被 apply 到状态机时就可以返回客户端结果。</p>

<p>我们先通过位于 etcd/etcdserver 目录下的样例来看看应用层是如何使用 ReadIndex 来保证 linearizable read 的：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="c">// v3_server.go</span><span class="x">

</span><span class="k">type</span><span class="x"> </span><span class="n">RaftKV</span><span class="x"> </span><span class="k">interface</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">Range</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">RangeRequest</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">RangeResponse</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x">
	</span><span class="n">Put</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">PutRequest</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">PutResponse</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x">
	</span><span class="n">DeleteRange</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">DeleteRangeRequest</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">DeleteRangeResponse</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x">
	</span><span class="n">Txn</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">TxnRequest</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">TxnResponse</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x">
	</span><span class="n">Compact</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">CompactionRequest</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">CompactionResponse</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">s</span><span class="x"> </span><span class="o">*</span><span class="n">EtcdServer</span><span class="p">)</span><span class="x"> </span><span class="n">Range</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">RangeRequest</span><span class="p">)</span><span class="x"> </span><span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">RangeResponse</span><span class="p">,</span><span class="x"> </span><span class="kt">error</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">var</span><span class="x"> </span><span class="n">resp</span><span class="x"> </span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">RangeResponse</span><span class="x">
	</span><span class="k">var</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="kt">error</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="o">!</span><span class="n">r</span><span class="o">.</span><span class="n">Serializable</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">err</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">linearizableReadNotify</span><span class="p">(</span><span class="n">ctx</span><span class="p">)</span><span class="x">  </span><span class="c">// 等待 linearizableReadNotify 返回 才能继续往下走</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">err</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="no">nil</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="c">// 读取数据逻辑 省略..</span><span class="x">
	</span><span class="o">...</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">resp</span><span class="p">,</span><span class="x"> </span><span class="n">err</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>在读请求 <code class="highlighter-rouge">Range</code> 执行前，调用了 <code class="highlighter-rouge">linearizableReadNotify</code>：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre></td><td class="rouge-code"><pre><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">s</span><span class="x"> </span><span class="o">*</span><span class="n">EtcdServer</span><span class="p">)</span><span class="x"> </span><span class="n">linearizableReadNotify</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">s</span><span class="o">.</span><span class="n">readMu</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span><span class="x">
	</span><span class="n">nc</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">readNotifier</span><span class="x">
	</span><span class="n">s</span><span class="o">.</span><span class="n">readMu</span><span class="o">.</span><span class="n">RUnlock</span><span class="p">()</span><span class="x">

	</span><span class="c">// signal linearizable loop for current notify if it hasn't been already</span><span class="x">
	</span><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">case</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">readwaitc</span><span class="x"> </span><span class="o">&lt;-</span><span class="x"> </span><span class="k">struct</span><span class="p">{}{}</span><span class="o">:</span><span class="x">
	</span><span class="k">default</span><span class="o">:</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="c">// wait for read state notification</span><span class="x">
	</span><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">case</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">nc</span><span class="o">.</span><span class="n">c</span><span class="o">:</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="n">nc</span><span class="o">.</span><span class="n">err</span><span class="x">
	</span><span class="k">case</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">ctx</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span><span class="o">:</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="n">ctx</span><span class="o">.</span><span class="n">Err</span><span class="p">()</span><span class="x">
	</span><span class="k">case</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">s</span><span class="o">.</span><span class="n">done</span><span class="o">:</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="n">ErrStopped</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="highlighter-rouge">linearizableReadNotify</code> 往 <code class="highlighter-rouge">readwaitc</code> 发送个空的结构体，并且等待 <code class="highlighter-rouge">nc.c</code> 的返回。<code class="highlighter-rouge">readwaitc</code> 是在另外的 goroutine <code class="highlighter-rouge">linearizableReadLoop</code> 里监听的：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre></td><td class="rouge-code"><pre><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">s</span><span class="x"> </span><span class="o">*</span><span class="n">EtcdServer</span><span class="p">)</span><span class="x"> </span><span class="n">linearizableReadLoop</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">var</span><span class="x"> </span><span class="n">rs</span><span class="x"> </span><span class="n">raft</span><span class="o">.</span><span class="n">ReadState</span><span class="x">

	</span><span class="k">for</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">ctx</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="x"> </span><span class="m">8</span><span class="p">)</span><span class="x">
		</span><span class="n">binary</span><span class="o">.</span><span class="n">BigEndian</span><span class="o">.</span><span class="n">PutUint64</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">reqIDGen</span><span class="o">.</span><span class="n">Next</span><span class="p">())</span><span class="x">  </span><span class="c">// ctx 即请求唯一标识 reqId</span><span class="x">

		</span><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">s</span><span class="o">.</span><span class="n">readwaitc</span><span class="o">:</span><span class="x">  </span><span class="c">// 监听 readwaitc</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">s</span><span class="o">.</span><span class="n">stopping</span><span class="o">:</span><span class="x">
			</span><span class="k">return</span><span class="x">
		</span><span class="p">}</span><span class="x">

		</span><span class="n">nextnr</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">newNotifier</span><span class="p">()</span><span class="x">
		</span><span class="n">nr</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">readNotifier</span><span class="x">
		</span><span class="n">s</span><span class="o">.</span><span class="n">readNotifier</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">nextnr</span><span class="x">

		</span><span class="n">s</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">ReadIndex</span><span class="p">(</span><span class="n">cctx</span><span class="p">,</span><span class="x"> </span><span class="n">ctx</span><span class="p">)</span><span class="x">  </span><span class="c">// 调用 ReadIndex 接口，往 recvc channel 发送 type 为 pb.MsgReadIndex 的请求</span><span class="x">

		</span><span class="k">var</span><span class="x"> </span><span class="p">(</span><span class="x">
			</span><span class="n">timeout</span><span class="x"> </span><span class="kt">bool</span><span class="x">
			</span><span class="n">done</span><span class="x">    </span><span class="kt">bool</span><span class="x">
		</span><span class="p">)</span><span class="x">
		</span><span class="k">for</span><span class="x"> </span><span class="o">!</span><span class="n">timeout</span><span class="x"> </span><span class="o">&amp;&amp;</span><span class="x"> </span><span class="o">!</span><span class="n">done</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">case</span><span class="x"> </span><span class="n">rs</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">s</span><span class="o">.</span><span class="n">r</span><span class="o">.</span><span class="n">readStateC</span><span class="o">:</span><span class="x">  </span><span class="c">// 收到 ready 对象时，会往 readStateC channel 传回来 readState，见 etcd/etcdserver/raft.go 文件的 func (r *raftNode) start(rh *raftReadyHandler)</span><span class="x">
				</span><span class="n">done</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">bytes</span><span class="o">.</span><span class="n">Equal</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">RequestCtx</span><span class="p">,</span><span class="x"> </span><span class="n">ctx</span><span class="p">)</span><span class="x">  </span><span class="c">// 比较下 reqId 是否一致</span><span class="x">
			</span><span class="k">case</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">time</span><span class="o">.</span><span class="n">After</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">Cfg</span><span class="o">.</span><span class="n">ReqTimeout</span><span class="p">())</span><span class="o">:</span><span class="x">
				</span><span class="n">nr</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="n">ErrTimeout</span><span class="p">)</span><span class="x">
				</span><span class="n">timeout</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="no">true</span><span class="x">
			</span><span class="k">case</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">s</span><span class="o">.</span><span class="n">stopping</span><span class="o">:</span><span class="x">
				</span><span class="k">return</span><span class="x">
			</span><span class="p">}</span><span class="x">
		</span><span class="p">}</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="o">!</span><span class="n">done</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">continue</span><span class="x">
		</span><span class="p">}</span><span class="x">

        </span><span class="c">// 等待 readState 里的 index，也就是收到 pb.MsgReadIndex 请求时，leader 节点当前的 commit index 被 apply 到状态机时，此时调用 nr.notify(nil) 通知应用层可以读取状态机里的数据了，确保读到的不是 stale 数据</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">ai</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">s</span><span class="o">.</span><span class="n">getAppliedIndex</span><span class="p">();</span><span class="x"> </span><span class="n">ai</span><span class="x"> </span><span class="o">&lt;</span><span class="x"> </span><span class="n">rs</span><span class="o">.</span><span class="n">Index</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">select</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">case</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">s</span><span class="o">.</span><span class="n">applyWait</span><span class="o">.</span><span class="n">Wait</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">Index</span><span class="p">)</span><span class="o">:</span><span class="x">
			</span><span class="k">case</span><span class="x"> </span><span class="o">&lt;-</span><span class="n">s</span><span class="o">.</span><span class="n">stopping</span><span class="o">:</span><span class="x">
				</span><span class="k">return</span><span class="x">
			</span><span class="p">}</span><span class="x">
		</span><span class="p">}</span><span class="x">
		</span><span class="c">// unblock all l-reads requested at indices before rs.Index</span><span class="x">
		</span><span class="n">nr</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="no">nil</span><span class="p">)</span><span class="x">
	</span><span class="p">}</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>在 <code class="highlighter-rouge">linearizableReadLoop</code> 调用 <code class="highlighter-rouge">nr.notify</code> 后，<code class="highlighter-rouge">linearizableReadNotify</code> 从 select 阻塞中返回，此时就可以继续走 <code class="highlighter-rouge">Range</code> 的逻辑，读取数据，返回给客户端。</p>

<p>从上面的例子，我们了解了应用层如何使用 Node 的 <code class="highlighter-rouge">ReadIndex</code> 接口来实现 linearizable read。下面我们来介绍 <code class="highlighter-rouge">ReadIndex</code> 这个新接口：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="c">// Node represents a node in a raft cluster.</span><span class="x">
</span><span class="k">type</span><span class="x"> </span><span class="n">Node</span><span class="x"> </span><span class="k">interface</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// Propose proposes that data be appended to the log.</span><span class="x">
	</span><span class="n">Propose</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">data</span><span class="x"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x">

	</span><span class="c">// Ready returns a channel that returns the current point-in-time state.</span><span class="x">
	</span><span class="c">// Users of the Node must call Advance after retrieving the state returned by Ready.</span><span class="x">
	</span><span class="c">//</span><span class="x">
	</span><span class="c">// NOTE: No committed entries from the next Ready may be applied until all committed entries</span><span class="x">
	</span><span class="c">// and snapshots from the previous one have finished.</span><span class="x">
	</span><span class="n">Ready</span><span class="p">()</span><span class="x"> </span><span class="o">&lt;-</span><span class="k">chan</span><span class="x"> </span><span class="n">Ready</span><span class="x">

	</span><span class="c">// Advance notifies the Node that the application has saved progress up to the last Ready.</span><span class="x">
	</span><span class="c">// It prepares the node to return the next available Ready.</span><span class="x">
	</span><span class="c">//</span><span class="x">
	</span><span class="c">// The application should generally call Advance after it applies the entries in last Ready.</span><span class="x">
	</span><span class="c">//</span><span class="x">
	</span><span class="c">// However, as an optimization, the application may call Advance while it is applying the</span><span class="x">
	</span><span class="c">// commands. For example. when the last Ready contains a snapshot, the application might take</span><span class="x">
	</span><span class="c">// a long time to apply the snapshot data. To continue receiving Ready without blocking raft</span><span class="x">
	</span><span class="c">// progress, it can call Advance before finishing applying the last ready.</span><span class="x">
	</span><span class="n">Advance</span><span class="p">()</span><span class="x">

	</span><span class="c">// ReadIndex request a read state. The read state will be set in the ready.</span><span class="x">
	</span><span class="c">// Read state has a read index. Once the application advances further than the read</span><span class="x">
	</span><span class="c">// index, any linearizable read requests issued before the read request can be</span><span class="x">
	</span><span class="c">// processed safely. The read state will have the same rctx attached.</span><span class="x">
	</span><span class="n">ReadIndex</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">rctx</span><span class="x"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x">
</span><span class="p">}</span><span class="x">

</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">n</span><span class="x"> </span><span class="o">*</span><span class="n">node</span><span class="p">)</span><span class="x"> </span><span class="n">ReadIndex</span><span class="p">(</span><span class="n">ctx</span><span class="x"> </span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span><span class="x"> </span><span class="n">rctx</span><span class="x"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">n</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="x"> </span><span class="n">pb</span><span class="o">.</span><span class="n">Message</span><span class="p">{</span><span class="n">Type</span><span class="o">:</span><span class="x"> </span><span class="n">pb</span><span class="o">.</span><span class="n">MsgReadIndex</span><span class="p">,</span><span class="x"> </span><span class="n">Entries</span><span class="o">:</span><span class="x"> </span><span class="p">[]</span><span class="n">pb</span><span class="o">.</span><span class="n">Entry</span><span class="p">})</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>上篇文章 <a href="http://masutangu.com/2018/07/etcd-raft-note-2/">《etcd-raft 源码学习笔记（概览篇）》</a> 提到当节点为 leader 时，<code class="highlighter-rouge">step</code> 被设置为 <code class="highlighter-rouge">stepLeader</code> 。我们来看看 <code class="highlighter-rouge">stepLeader</code> 是如何处理 type 为 pb.MsgReadIndex 的 readIndexReq 的：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="rouge-code"><pre><span class="k">func</span><span class="x"> </span><span class="n">stepLeader</span><span class="p">(</span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">raft</span><span class="p">,</span><span class="x"> </span><span class="n">m</span><span class="x"> </span><span class="n">pb</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// These message types do not require any progress for m.From.</span><span class="x">
	</span><span class="k">switch</span><span class="x"> </span><span class="n">m</span><span class="o">.</span><span class="n">Type</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">case</span><span class="x"> </span><span class="n">pb</span><span class="o">.</span><span class="n">MsgReadIndex</span><span class="o">:</span><span class="x">
		</span><span class="c">// raft 5.4 safty 检查</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">raftLog</span><span class="o">.</span><span class="n">zeroTermOnErrCompacted</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">raftLog</span><span class="o">.</span><span class="n">term</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">raftLog</span><span class="o">.</span><span class="n">committed</span><span class="p">))</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">Term</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="c">// Reject read only request when this leader has not committed any log entry at its term.</span><span class="x">
			</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
		</span><span class="p">}</span><span class="x">

		</span><span class="c">// thinking: use an interally defined context instead of the user given context.</span><span class="x">
		</span><span class="c">// We can express this in terms of the term and index instead of a user-supplied value.</span><span class="x">
		</span><span class="c">// This would allow multiple reads to piggyback on the same message.</span><span class="x">
		</span><span class="k">switch</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">readOnly</span><span class="o">.</span><span class="n">option</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">case</span><span class="x"> </span><span class="n">ReadOnlySafe</span><span class="o">:</span><span class="x">
			</span><span class="n">r</span><span class="o">.</span><span class="n">readOnly</span><span class="o">.</span><span class="n">addRequest</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">raftLog</span><span class="o">.</span><span class="n">committed</span><span class="p">,</span><span class="x"> </span><span class="n">m</span><span class="p">)</span><span class="x">  </span><span class="c">// r.raftLog.committed 为 当前 commit index</span><span class="x">
			</span><span class="n">r</span><span class="o">.</span><span class="n">bcastHeartbeatWithCtx</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Entries</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="n">Data</span><span class="p">)</span><span class="x">  </span><span class="c">// 广播心跳包</span><span class="x">
		</span><span class="p">}</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">

	
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>收到 readIndexReq 后，首先调用 <code class="highlighter-rouge">r.readOnly.addRequest</code> 保存下，然后调用 <code class="highlighter-rouge">bcastHeartbeatWithCtx</code> 广播心跳包， ctx 即唯一标识 readIndexReq 的 reqId。</p>

<p>来看看 raft 是如何管理 readIndexReq 的：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="c">// addRequest adds a read only reuqest into readonly struct.</span><span class="x">
</span><span class="c">// `index` is the commit index of the raft state machine when it received</span><span class="x">
</span><span class="c">// the read only request.</span><span class="x">
</span><span class="c">// `m` is the original read only request message from the local or remote node.</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">ro</span><span class="x"> </span><span class="o">*</span><span class="n">readOnly</span><span class="p">)</span><span class="x"> </span><span class="n">addRequest</span><span class="p">(</span><span class="n">index</span><span class="x"> </span><span class="kt">uint64</span><span class="p">,</span><span class="x"> </span><span class="n">m</span><span class="x"> </span><span class="n">pb</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">ctx</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="kt">string</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Entries</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="n">Data</span><span class="p">)</span><span class="x">  </span><span class="c">// ctx 即 reqId</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">ok</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ro</span><span class="o">.</span><span class="n">pendingReadIndex</span><span class="p">[</span><span class="n">ctx</span><span class="p">];</span><span class="x"> </span><span class="n">ok</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">return</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="n">ro</span><span class="o">.</span><span class="n">pendingReadIndex</span><span class="p">[</span><span class="n">ctx</span><span class="p">]</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="o">&amp;</span><span class="n">readIndexStatus</span><span class="p">{</span><span class="n">index</span><span class="o">:</span><span class="x"> </span><span class="n">index</span><span class="p">,</span><span class="x"> </span><span class="n">req</span><span class="o">:</span><span class="x"> </span><span class="n">m</span><span class="p">,</span><span class="x"> </span><span class="n">acks</span><span class="o">:</span><span class="x"> </span><span class="nb">make</span><span class="p">(</span><span class="k">map</span><span class="p">[</span><span class="kt">uint64</span><span class="p">]</span><span class="k">struct</span><span class="p">{})}</span><span class="x">  </span><span class="c">// acks 用于记录哪些 peer 已经 ack 确认。之后用于统计是否大于 quonum</span><span class="x">
	</span><span class="n">ro</span><span class="o">.</span><span class="n">readIndexQueue</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">ro</span><span class="o">.</span><span class="n">readIndexQueue</span><span class="p">,</span><span class="x"> </span><span class="n">ctx</span><span class="p">)</span><span class="x">  </span><span class="c">// append 进 readIndexQueue</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>再看看 <code class="highlighter-rouge">stepLeader</code> 如何处理心跳回包：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">func</span><span class="x"> </span><span class="n">stepLeader</span><span class="p">(</span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">raft</span><span class="p">,</span><span class="x"> </span><span class="n">m</span><span class="x"> </span><span class="n">pb</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span><span class="x"> </span><span class="kt">error</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="c">// These message types do not require any progress for m.From.</span><span class="x">
	</span><span class="k">switch</span><span class="x"> </span><span class="n">m</span><span class="o">.</span><span class="n">Type</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">case</span><span class="x"> </span><span class="n">pb</span><span class="o">.</span><span class="n">MsgHeartbeatResp</span><span class="o">:</span><span class="x">
		</span><span class="n">pr</span><span class="o">.</span><span class="n">RecentActive</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="no">true</span><span class="x">
		</span><span class="n">pr</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span><span class="x">

		</span><span class="k">if</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">readOnly</span><span class="o">.</span><span class="n">option</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="n">ReadOnlySafe</span><span class="x"> </span><span class="o">||</span><span class="x"> </span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="m">0</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
		</span><span class="p">}</span><span class="x">

		</span><span class="n">ackCount</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">readOnly</span><span class="o">.</span><span class="n">recvAck</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">ackCount</span><span class="x"> </span><span class="o">&lt;</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">quorum</span><span class="p">()</span><span class="x"> </span><span class="p">{</span><span class="x">  </span><span class="c">// 判断是否收到 quorum 的心跳回包</span><span class="x">
			</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
		</span><span class="p">}</span><span class="x">

        </span><span class="c">// 收到 quorum 的心跳回包了，把 readIndexReq 依次 append r.readStates 中，返回 ready 对象时会包含 r.readStates</span><span class="x">
		</span><span class="n">rss</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">readOnly</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="x">
		</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">rs</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">rss</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="n">req</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">rs</span><span class="o">.</span><span class="n">req</span><span class="x">
			</span><span class="k">if</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">From</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="n">None</span><span class="x"> </span><span class="o">||</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">From</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">id</span><span class="x"> </span><span class="p">{</span><span class="x"> </span><span class="c">// from local member</span><span class="x">
				</span><span class="n">r</span><span class="o">.</span><span class="n">readStates</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">readStates</span><span class="p">,</span><span class="x"> </span><span class="n">ReadState</span><span class="p">{</span><span class="n">Index</span><span class="o">:</span><span class="x"> </span><span class="n">rs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="x"> </span><span class="n">RequestCtx</span><span class="o">:</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">Entries</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="n">Data</span><span class="p">})</span><span class="x">
			</span><span class="p">}</span><span class="x"> </span><span class="k">else</span><span class="x"> </span><span class="p">{</span><span class="x">
				</span><span class="n">r</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">pb</span><span class="o">.</span><span class="n">Message</span><span class="p">{</span><span class="n">To</span><span class="o">:</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">From</span><span class="p">,</span><span class="x"> </span><span class="n">Type</span><span class="o">:</span><span class="x"> </span><span class="n">pb</span><span class="o">.</span><span class="n">MsgReadIndexResp</span><span class="p">,</span><span class="x"> </span><span class="n">Index</span><span class="o">:</span><span class="x"> </span><span class="n">rs</span><span class="o">.</span><span class="n">index</span><span class="p">,</span><span class="x"> </span><span class="n">Entries</span><span class="o">:</span><span class="x"> </span><span class="n">req</span><span class="o">.</span><span class="n">Entries</span><span class="p">})</span><span class="x">
			</span><span class="p">}</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>调用 <code class="highlighter-rouge">r.readOnly.recvAck</code>，根据 readIndeReq 的 reqId 统计收到心跳回包的数量：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c">// recvAck notifies the readonly struct that the raft state machine received</span><span class="x">
</span><span class="c">// an acknowledgment of the heartbeat that attached with the read only request</span><span class="x">
</span><span class="c">// context.</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">ro</span><span class="x"> </span><span class="o">*</span><span class="n">readOnly</span><span class="p">)</span><span class="x"> </span><span class="n">recvAck</span><span class="p">(</span><span class="n">m</span><span class="x"> </span><span class="n">pb</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span><span class="x"> </span><span class="kt">int</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">rs</span><span class="p">,</span><span class="x"> </span><span class="n">ok</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ro</span><span class="o">.</span><span class="n">pendingReadIndex</span><span class="p">[</span><span class="kt">string</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Context</span><span class="p">)]</span><span class="x">
	</span><span class="k">if</span><span class="x"> </span><span class="o">!</span><span class="n">ok</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="m">0</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="n">rs</span><span class="o">.</span><span class="n">acks</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">From</span><span class="p">]</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="k">struct</span><span class="p">{}{}</span><span class="x">  </span><span class="c">// 记录下收到 m.From 这个节点的 ack</span><span class="x">
	</span><span class="c">// add one to include an ack from local node</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="nb">len</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">acks</span><span class="p">)</span><span class="x"> </span><span class="o">+</span><span class="x"> </span><span class="m">1</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>如果超过 quonum 表示该节点依然是 leader，此时从 <code class="highlighter-rouge">r.readOnly.advance</code> 拿到保存的 readIndexReq，append 到 <code class="highlighter-rouge">r.readStates</code> 中：</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre></td><td class="rouge-code"><pre><span class="c">// advance advances the read only request queue kept by the readonly struct.</span><span class="x">
</span><span class="c">// It dequeues the requests until it finds the read only request that has</span><span class="x">
</span><span class="c">// the same context as the given `m`.</span><span class="x">
</span><span class="k">func</span><span class="x"> </span><span class="p">(</span><span class="n">ro</span><span class="x"> </span><span class="o">*</span><span class="n">readOnly</span><span class="p">)</span><span class="x"> </span><span class="n">advance</span><span class="p">(</span><span class="n">m</span><span class="x"> </span><span class="n">pb</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span><span class="x"> </span><span class="p">[]</span><span class="o">*</span><span class="n">readIndexStatus</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="k">var</span><span class="x"> </span><span class="p">(</span><span class="x">
		</span><span class="n">i</span><span class="x">     </span><span class="kt">int</span><span class="x">
		</span><span class="n">found</span><span class="x"> </span><span class="kt">bool</span><span class="x">
	</span><span class="p">)</span><span class="x">

	</span><span class="n">ctx</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="kt">string</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span><span class="x">
	</span><span class="n">rss</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="p">[]</span><span class="o">*</span><span class="n">readIndexStatus</span><span class="p">{}</span><span class="x">

	</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">okctx</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">ro</span><span class="o">.</span><span class="n">readIndexQueue</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">i</span><span class="o">++</span><span class="x">
		</span><span class="n">rs</span><span class="p">,</span><span class="x"> </span><span class="n">ok</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">ro</span><span class="o">.</span><span class="n">pendingReadIndex</span><span class="p">[</span><span class="n">okctx</span><span class="p">]</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="o">!</span><span class="n">ok</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="nb">panic</span><span class="p">(</span><span class="s">"cannot find corresponding read state from pending map"</span><span class="p">)</span><span class="x">
		</span><span class="p">}</span><span class="x">
		</span><span class="n">rss</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="nb">append</span><span class="p">(</span><span class="n">rss</span><span class="p">,</span><span class="x"> </span><span class="n">rs</span><span class="p">)</span><span class="x">
		</span><span class="k">if</span><span class="x"> </span><span class="n">okctx</span><span class="x"> </span><span class="o">==</span><span class="x"> </span><span class="n">ctx</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="c">// 取出 reqId 相同的 ReadState 和其前面的所有 ReadState </span><span class="x">
			</span><span class="n">found</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="no">true</span><span class="x">
			</span><span class="k">break</span><span class="x">
		</span><span class="p">}</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">if</span><span class="x"> </span><span class="n">found</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">ro</span><span class="o">.</span><span class="n">readIndexQueue</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">ro</span><span class="o">.</span><span class="n">readIndexQueue</span><span class="p">[</span><span class="n">i</span><span class="o">:</span><span class="p">]</span><span class="x">
		</span><span class="k">for</span><span class="x"> </span><span class="n">_</span><span class="p">,</span><span class="x"> </span><span class="n">rs</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="k">range</span><span class="x"> </span><span class="n">rss</span><span class="x"> </span><span class="p">{</span><span class="x">
			</span><span class="nb">delete</span><span class="p">(</span><span class="n">ro</span><span class="o">.</span><span class="n">pendingReadIndex</span><span class="p">,</span><span class="x"> </span><span class="kt">string</span><span class="p">(</span><span class="n">rs</span><span class="o">.</span><span class="n">req</span><span class="o">.</span><span class="n">Entries</span><span class="p">[</span><span class="m">0</span><span class="p">]</span><span class="o">.</span><span class="n">Data</span><span class="p">))</span><span class="x">
		</span><span class="p">}</span><span class="x">
		</span><span class="k">return</span><span class="x"> </span><span class="n">rss</span><span class="x">
	</span><span class="p">}</span><span class="x">

	</span><span class="k">return</span><span class="x"> </span><span class="no">nil</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>

<p>之后调用 <code class="highlighter-rouge">newReady</code> 会把 <code class="highlighter-rouge">r.readStates</code> 返回给应用层，应用层取出 readIndexReq 中的 commit index，等到其被 apply 到状态机就可以允许读操作了。</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="k">func</span><span class="x"> </span><span class="n">newReady</span><span class="p">(</span><span class="n">r</span><span class="x"> </span><span class="o">*</span><span class="n">raft</span><span class="p">,</span><span class="x"> </span><span class="n">prevSoftSt</span><span class="x"> </span><span class="o">*</span><span class="n">SoftState</span><span class="p">,</span><span class="x"> </span><span class="n">prevHardSt</span><span class="x"> </span><span class="n">pb</span><span class="o">.</span><span class="n">HardState</span><span class="p">)</span><span class="x"> </span><span class="n">Ready</span><span class="x"> </span><span class="p">{</span><span class="x">
	</span><span class="n">rd</span><span class="x"> </span><span class="o">:=</span><span class="x"> </span><span class="n">Ready</span><span class="p">{</span><span class="x">
		</span><span class="n">Entries</span><span class="o">:</span><span class="x">          </span><span class="n">r</span><span class="o">.</span><span class="n">raftLog</span><span class="o">.</span><span class="n">unstableEntries</span><span class="p">(),</span><span class="x">
		</span><span class="n">CommittedEntries</span><span class="o">:</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">raftLog</span><span class="o">.</span><span class="n">nextEnts</span><span class="p">(),</span><span class="x">
		</span><span class="n">Messages</span><span class="o">:</span><span class="x">         </span><span class="n">r</span><span class="o">.</span><span class="n">msgs</span><span class="p">,</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="o">...</span><span class="x">
	
	</span><span class="k">if</span><span class="x"> </span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">readStates</span><span class="p">)</span><span class="x"> </span><span class="o">!=</span><span class="x"> </span><span class="m">0</span><span class="x"> </span><span class="p">{</span><span class="x">
		</span><span class="n">rd</span><span class="o">.</span><span class="n">ReadStates</span><span class="x"> </span><span class="o">=</span><span class="x"> </span><span class="n">r</span><span class="o">.</span><span class="n">readStates</span><span class="x">  </span><span class="c">// 附上 r.readStates</span><span class="x">
	</span><span class="p">}</span><span class="x">
	</span><span class="o">...</span><span class="x">
	</span><span class="k">return</span><span class="x"> </span><span class="n">rd</span><span class="x">
</span><span class="p">}</span><span class="x">
</span></pre></td></tr></tbody></table></code></pre></div></div>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2018/07/04/etcd-raft-note-2/" data-toggle="tooltip" data-placement="top" title="etcd-raft 源码学习笔记（概览篇）">
                        Previous<br>
                        <span>etcd-raft 源码学习笔记（概览篇）</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2018/07/06/etcd-raft-note-4/" data-toggle="tooltip" data-placement="top" title="etcd-raft 源码学习笔记（Linearizable Read 之 Lease）">
                        Next<br>
                        <span>etcd-raft 源码学习笔记（Linearizable Read 之 Lease）</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        </a>
        
        
                <a data-sort="0058" 
                    href="/archive/?tag=%E4%B8%AA%E4%BA%BA%E9%A1%B9%E7%9B%AE"
                    title="个人项目"
                    rel="4">个人项目</a>
        
                <a data-sort="0040" 
                    href="/archive/?tag=%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0"
                    title="读书笔记"
                    rel="22">读书笔记</a>
        
                <a data-sort="0047" 
                    href="/archive/?tag=%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"
                    title="源码阅读"
                    rel="15">源码阅读</a>
        
                <a data-sort="0055" 
                    href="/archive/?tag=%E5%B7%A5%E4%BD%9C"
                    title="工作"
                    rel="7">工作</a>
        
                <a data-sort="0059" 
                    href="/archive/?tag=%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80"
                    title="编程语言"
                    rel="3">编程语言</a>
        
                <a data-sort="0059" 
                    href="/archive/?tag=%E9%9A%8F%E7%AC%94"
                    title="随笔"
                    rel="3">随笔</a>
        
                <a data-sort="0060" 
                    href="/archive/?tag=%E4%BC%98%E5%8C%96%26%E9%87%8D%E6%9E%84"
                    title="优化&重构"
                    rel="2">优化&重构</a>
        
                <a data-sort="0060" 
                    href="/archive/?tag=%E6%95%B0%E6%8D%AE%E5%BA%93"
                    title="数据库"
                    rel="2">数据库
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="https://blog.zhiheng.io">onlyice</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  
  
  
  <li>
    <a target="_blank" href="https://github.com/masutangu">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  
  <li>
    <a target="_blank" href="https://www.instagram.com/masutanguu">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Masutangu 2018
                    <br>
                    Powered by <a href="http://huangxuan.me">Hux Blog</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->





<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-77236140-1';
    var _gaDomain = 'masutangu.com';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->



<!-- Multi-Lingual -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
