<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>MIT 6.824 学习笔记（五）</title>
  <meta name="description" content="本系列文章是对 MIT 6.824 课程的学习笔记。">
  <meta name="author" content="Wei Wang">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="MIT 6.824 学习笔记（五）">
  <meta name="twitter:description" content="本系列文章是对 MIT 6.824 课程的学习笔记。">
  
  <meta property="og:type" content="article">
  <meta property="og:title" content="MIT 6.824 学习笔记（五）">
  <meta property="og:description" content="本系列文章是对 MIT 6.824 课程的学习笔记。">
  
  <link rel="icon" type="image/png" href="/assets/images/favicon.png" />
  <link href="/assets/images/favicon.png" rel="shortcut icon" type="image/png">
  
  <link rel="stylesheet" href="/css/main.css">
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="canonical" href="http://masutangu.com/2018/01/mit-6824-note-5/">
  <link rel="alternate" type="application/rss+xml" title="Masutangu" href="http://masutangu.com/feed.xml">
  
  <meta name="google-site-verification" content="1-1ZlHoRvM0T2FqPbW2S-qLgYXN6rsn52kErlMPd_gw" />
  
</head>


  <body>

    <span class="mobile btn-mobile-menu">
        <i class="fa fa-list btn-mobile-menu__icon"></i>
        <i class="fa fa-angle-up btn-mobile-close__icon hidden"></i>
    </span>
    
    <header class="panel-cover panel-cover--collapsed" style="background-image: url('/assets/images/background-cover.jpg')">
  <div class="panel-main">

    <div class="panel-main__inner panel-inverted">
    <div class="panel-main__content">

        <a href="/#blog" title="前往 Masutangu 的主页" class="blog-button"><img src="/assets/images/avatar.jpg" width="80" alt="Masutangu logo" class="panel-cover__logo logo" /></a>
        <h1 class="panel-cover__title panel-title"><a href="/#blog" title="link to homepage for Masutangu" class="blog-button">Masutangu</a></h1>
        
        <span class="panel-cover__subtitle panel-subtitle">长风破浪会有时 直挂云帆济沧海</span>
        
        <hr class="panel-cover__divider" />
        <p class="panel-cover__description">也許我這一生　始終在追逐那顆九號球</p>
        <hr class="panel-cover__divider panel-cover__divider--secondary" />
        
        
        
        <div class="navigation-wrapper">
          <div>
            <nav class="cover-navigation cover-navigation--primary">
              <ul class="navigation">
                <li class="navigation__item"><a href="/#blog" title="Visit blog" class="blog-button">博客</a></li>
                
                  <li class="navigation__item"><a href="http://500px.me/community/user-details/5cc3fb7c1480fb4fc2140a09627457614" target="_blank" title="Life">生活</a></li>
                
                  <li class="navigation__item"><a href="https://about.me/masutangu" target="_blank" title="About me">关于</a></li>
                
              </ul>
            </nav>
          </div>
          
          <div><nav class="cover-navigation navigation--social">
  <ul class="navigation">

  

  
  <!-- Github -->
  <li class="navigation__item">
    <a href="https://github.com/masutangu" title="@masutangu 的 Github" target="_blank">
      <i class='social fa fa-github'></i>
      <span class="label">Github</span>
    </a>
  </li>
  
  
  

  

  <!-- RSS -->
  <li class="navigation__item">
    <a href="/feed.xml" rel="author" title="RSS" target="_blank">
      <i class='social fa fa-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>

  
  <!-- Email -->
  <li class="navigation__item">
    <a href="mailto:masutangu.cs@gmail.com" title="Contact me">
      <i class='social fa fa-envelope'></i>
      <span class="label">Email</span>
    </a>
  </li>
  

  </ul>
</nav>
</div>
        </div>
      </div>
    </div>
    
    
    <div class="panel-cover--overlay cover-blue"></div>
    
  </div>
</header>


    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            <article class="post-container post-container--single" itemscope itemtype="http://schema.org/BlogPosting">
  <header class="post-header">
    <div class="post-meta">
      <time datetime="2018-01-11 22:14:04 +0800" itemprop="datePublished" class="post-meta__date date">2018-01-11</time> &#8226; <span class="post-meta__tags tags">读书笔记</span>
    </div>
    <h1 class="post-title">MIT 6.824 学习笔记（五）</h1>
  </header>

  <section class="post">
    <p>本系列文章是对 <a href="https://pdos.csail.mit.edu/6.824/schedule.html">MIT 6.824</a> 课程的学习笔记。</p>

<h1>FaRM Note</h1>

<p>FaRM writes go to RAM, not disk -- eliminates a huge bottleneck. Can write RAM in 200 ns, but takes 10 ms to write hard drive, 100 us for SSD, but RAM loses content in power failure! Not persistent by itself.  </p>

<p>Just write to RAM of f+1 machines, to tolerate f failures? Might be enough if failures were always independent, but power failure is not independent -- may strike 100% of machines!</p>

<p>So batteries in every rack, can run machines for a few minutes: <strong>&quot;non-volatile RAM&quot;</strong>. What if crash prevents s/w from writing SSD, e.g bug in FaRM or kernel, or cpu/memory/hardware error. FaRM copes with single-machine crashes by copying data from RAM of machines&#39; replicas to other machines to ensure always f+1 copies. Crashes (other than power failure) must be independent!</p>

<p>why is the network often a performance bottleneck?</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">    the usual setup:
    app                       app
    ---                       ---
    socket buffers            buffers
    TCP                       TCP
    NIC driver                driver
    NIC  -------------------- NIC
</code></pre></figure>
<p>lots of expensive CPU operations:</p>

<ul>
<li>system calls</li>
<li>copy messages</li>
<li>interrupts</li>
</ul>

<p>and all twice if RPC! It&#39;s hard to build RPC than can deliver more than a few 100,000 / second wire b/w (e.g. 10 gigabits/second) is rarely the limit for short RPC. These per-packet CPU costs are the limiting factor for small messages.</p>

<p>Two classes of concurrency control for transactions:</p>

<ul>
<li><p>pessimistic:
wait for lock on first use of object; hold until commit/abort, called two-phase locking. Conflicts cause delays</p></li>
<li><p>optimistic:
access object without locking; commit &quot;validates&quot; to see if OK. </p>

<ul>
<li>Valid: do the writes</li>
<li>Invalid: abort
called <strong>Optimistic Concurrency Control (OCC)</strong></li>
</ul></li>
</ul>

<p>FaRM uses OCC. The reason: OCC lets FaRM read using one-sided RDMA reads, server storing the object does not need to set a lock, due to OCC.</p>

<p>FaRM transaction API (simplified):</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">  txCreate()
  o = txRead(oid)  -- RDMA
  o.f += 1
  txWrite(oid, o)  -- purely local
  ok = txCommit()  -- Figure 4
</code></pre></figure>
<p>What&#39;s in an oid: <region #, address>. <code>region #</code> indexes a mapping to [ primary, backup1, ... ]. Target NIC can use address directly to read or write RAM so target CPU doesn&#39;t have to be involved.</p>

<p>Server memory layout: regions, each an array of objects
Object layout: header with version # and lock</p>

<p>Every region replicated on one primary, f backups -- f+1 replicas. Only the primary serves reads; all f+1 see commits+writes replication yields availability if &lt;= f failures, i.e. available as long as one replica stays alive; better than Raft!</p>

<ul>
<li><p>txRead
one-sided RDMA to fetch object direct from primary&#39;s memory -- fast!
also fetches object&#39;s version number, to detect concurrent writes</p></li>
<li><p>txWrite
must be preceded by txRead
just writes local copy; no communication</p></li>
<li><p>transaction execution / commit protocol without failure -- Figure 4</p>

<ul>
<li><p>LOCK (first message in commit protocol)</p>

<p>TC sends to primary of each written object
TC uses RDMA to append to its log at each primary
LOCK record contains oid, version # xaction read, new value
primary s/w polls log, sees LOCK, validates, sends &quot;yes&quot; or &quot;no&quot; reply message
note LOCK is both logged in primary&#39;s NVRAM <em>and</em> an RPC exchange</p></li>
</ul></li>
<li><p>what does primary CPU do on receipt of LOCK?</p>

<p>(for each object)
if object locked, or version != what xaction read, reply &quot;no&quot;
otherwise set the lock flag and return &quot;yes&quot;
note: does <em>not</em> block if object is already locked</p></li>
<li><p>TC waits for all LOCK reply messages</p>

<p>if any &quot;no&quot;, abort
send ABORT to primaries so they can release locks
returns &quot;no&quot; from txCommit()</p></li>
<li><p>TC sends COMMIT-PRIMARY to primary of each written object</p>

<p>uses RDMA to append to primary&#39;s log
TC only waits for hardware ack -- does not wait for primary to process log entry
TC returns &quot;yes&quot; from txCommit()</p></li>
<li><p>what does primary do when it processes the COMMIT-PRIMARY in its log?</p>

<p>copy new value over object&#39;s memory
increment object&#39;s version #
clear object&#39;s lock flag</p></li>
</ul>

  </section>
</article>

<section class="read-more">
   
   
   <div class="read-more-item">
       <span class="read-more-item-dim">最近的文章</span>
       <h2 class="post-list__post-title post-title"><a href="/2018/01/game-recover-based-on-replicated-state-machine/" title="link to 基于 Replicated State Machine 实现游戏进程恢复">基于 Replicated State Machine 实现游戏进程恢复</a></h2>
       <p class="excerpt">Introduction游戏服务器实现的业务逻辑普遍比较复杂，且大部分是带有状态的。如果进程重启或意外崩溃，会导致该服务器上的玩家断线，丢失进行中的游戏数据，带来极差的游戏体验。为了避免这种情况出现，一般游戏服务器都会持久化玩家数据以实现进程恢复，当重启或进程意外崩溃时，重新拉起进程后可以恢复到之前的状态。常用的做法是将玩家的状态信息保存在共享内存中，重启时加载共享内存进行恢复。共享内存虽然方便，但会有许多限制。比如 C++ 涉及到多态（虚函数表）、STL容器（heap分配），都不能直接映...&hellip;</p>
       <div class="post-list__meta"><time datetime="2018-01-13 11:30:24 +0800" class="post-list__meta--date date">2018-01-13</time> &#8226; <span class="post-list__meta--tags tags">工作</span><a class="btn-border-small" href=/2018/01/game-recover-based-on-replicated-state-machine/>继续阅读</a></div>
   </div>
   
   
   
   
   <div class="read-more-item">
       <span class="read-more-item-dim">更早的文章</span>
       <h2 class="post-list__post-title post-title"><a href="/2018/01/mit-6824-note-4/" title="link to MIT 6.824 学习笔记（四）">MIT 6.824 学习笔记（四）</a></h2>
       <p class="excerpt">本系列文章是对 MIT 6.824 课程的学习笔记。ZooKeeperAbstractZooKeeper 旨在提供简单高效的内核以供客户端实现更复杂的 coordination primitives。In addition to the wait-freeproperty, ZooKeeper provides a per client guarantee of FIFO execution of requests and linearizability for all requests ...&hellip;</p>
       <div class="post-list__meta"><time datetime="2018-01-10 19:53:45 +0800" class="post-list__meta--date date">2018-01-10</time> &#8226; <span class="post-list__meta--tags tags">读书笔记</span><a class="btn-border-small" href=/2018/01/mit-6824-note-4/>继续阅读</a></div>
   </div>
   
</section>

<section class="post-comments">
  
    <div id="disqus_thread"></div>
    <script>
    
    var disqus_config = function () {
        this.page.url = "http://masutangu.com/2018/01/mit-6824-note-5/";
        this.page.identifier = "/2018/01/mit-6824-note-5/";
    };

    var disqus_shortname = 'masutangu';
    
    (function() { // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');
        s.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();
    </script>
    <noscript>要查看<a href="http://disqus.com/?ref_noscript"> Disqus </a>评论，请启用 JavaScript</noscript>
    
  
  
  
  
</section>


            <section class="footer">
    <footer>
    	<span class="footer__copyright">本站点采用<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">知识共享 署名-非商业性使用-相同方式共享 4.0 国际 许可协议</a></span>
        <span class="footer__copyright">本站由 <a href="http://masutangu.com/">@masutangu</a> 创建，采用 <a href="https://github.com/onevcat/vno-jekyll">Vno - Jekyll</a> 作为主题，您可以在 GitHub 找到<a href="https://github.com/Masutangu/Masutangu.github.io">本站源码</a> - &copy; 2018</span>
    </footer>
</section>

        </div>
    </div>
    
    <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>

<script type="text/javascript" src="/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<script type="text/javascript" src="/js/main.js"></script>


<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-77236140-1', 'masutangu.com');
    ga('send', 'pageview');
</script>


    
  </body>

</html>
