<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="关于程序与设计、黑客与画家  这里是 Masutangu 的个人博客。">
    <meta name="keywords"  content="Masutangu, Masutangu 的博客, Masutangu Blog, 博客, 个人网站, 互联网, 后端, Python, Go, C++">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="浅读 Libco - Masutangu 的博客 | Masutangu Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="今天花了一天时间，学习了下微信的开源协程库 libco的代码，写下来做个纪录，有部分细节代码（包括 coctx_swap.S 那段汇编）我还没读懂，以后再补充进来。

">
    
    <meta property="article:published_time" content="2016-10-05T15:59:32Z">
    
    
    
    <meta property="article:tag" content="源码阅读">
    
    
    <meta property="og:image" content="http://localhost:4000/img/avatar.jpg">
    <meta property="og:url" content="http://localhost:4000/2016/10/05/learn-libco/">
    <meta property="og:site_name" content="Masutangu 的博客 | Masutangu Blog">
    
    <title>浅读 Libco - Masutangu 的博客 | Masutangu Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2016/10/05/learn-libco/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Masutangu</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">主页</a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a href="/about/">关于</a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="/archive/">归档</a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg');
        background: ;
    }

    
</style>

<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB" title="源码阅读">源码阅读</a>
                        
                    </div>
                    <h1>浅读 Libco</h1>
                    
                    <h2 class="subheading"></h2>
                    <span class="meta">Posted by Masutangu on October 5, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<p>今天花了一天时间，学习了下微信的开源协程库 <a href="https://github.com/tencent-wechat/libco">libco</a>的代码，写下来做个纪录，有部分细节代码（包括 coctx_swap.S 那段汇编）我还没读懂，以后再补充进来。</p>

<h2 id="协程的原理">协程的原理</h2>
<p>协程的概念和优点这里不再赘述。我们先介绍下实现协程的原理，再来看看相应的代码。</p>

<p>协程的切换，其实就是由我们手动来管理指令执行的上下文。一般每一个协程有自己的 context_buff 来保存自己的运行上下文（寄存器和栈）。当需要挂起当前协程时，将当前的上下文保存到该协程的 context_buff，并把当前上下文重置为新的协程的 context_buff 即可。</p>

<h2 id="hook-系统调用">hook 系统调用</h2>
<p>一般会在有 IO 阻塞操作的时候做协程的切换。如何让协程的使用者无需关心这些切换的细节呢？libco 采用 hooking IO 函数的方法。将 IO 设置为非阻塞，提交给 epoll 来管理，并让出 cpu 资源，等到 epoll 事件返回后再 resume 对应的协程。下面的代码会给出相应的例子。</p>

<h2 id="libco-源码">libco 源码</h2>

<ul>
  <li>
    <p>协程相关数据结构</p>

    <p>stCoRoutineEnv_t 管理协程的结构体，每起一个新的协程就压入 pCallStack 中，每挂起一个协程就将其踢出 pCallStack。</p>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>  <span class="k">struct</span> <span class="n">stCoRoutineEnv_t</span>
  <span class="p">{</span>
      <span class="n">stCoRoutine_t</span> <span class="o">*</span><span class="n">pCallStack</span><span class="p">[</span> <span class="mi">128</span> <span class="p">];</span>
      <span class="kt">int</span> <span class="n">iCallStackSize</span><span class="p">;</span>
      <span class="n">stCoEpoll_t</span> <span class="o">*</span><span class="n">pEpoll</span><span class="p">;</span>
  <span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>stCoRoutine_t 封装了协程对象，coctx_t 保存协程的 context。</p>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>  <span class="k">struct</span> <span class="n">stCoRoutine_t</span>
  <span class="p">{</span>
      <span class="n">stCoRoutineEnv_t</span> <span class="o">*</span><span class="n">env</span><span class="p">;</span>
      <span class="n">pfn_co_routine_t</span> <span class="n">pfn</span><span class="p">;</span>
      <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">;</span>
      <span class="n">coctx_t</span> <span class="n">ctx</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">cStart</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">cEnd</span><span class="p">;</span>
      <span class="n">stCoSpec_t</span> <span class="n">aSpec</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
      <span class="kt">char</span> <span class="n">cIsMain</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">cEnableSysHook</span><span class="p">;</span>
      <span class="kt">char</span> <span class="n">sRunStack</span><span class="p">[</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">128</span> <span class="p">];</span>
  <span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>epoll 相关数据结构</p>

    <p>管理 epoll 的结构体，pTimeout 管理 Timeout 事件。pstTimeoutList 为超时事件的列表。pstTimeoutList 和 pstActiveList 下面会看到其用法。</p>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>  <span class="k">struct</span> <span class="n">stCoEpoll_t</span>
  <span class="p">{</span>
      <span class="kt">int</span> <span class="n">iEpollFd</span><span class="p">;</span>
      <span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">_EPOLL_SIZE</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>
      <span class="k">struct</span> <span class="n">stTimeout_t</span> <span class="o">*</span><span class="n">pTimeout</span><span class="p">;</span>
      <span class="k">struct</span> <span class="n">stTimeoutItemLink_t</span> <span class="o">*</span><span class="n">pstTimeoutList</span><span class="p">;</span>  
      <span class="k">struct</span> <span class="n">stTimeoutItemLink_t</span> <span class="o">*</span><span class="n">pstActiveList</span><span class="p">;</span>
      <span class="n">co_epoll_res</span> <span class="o">*</span><span class="n">result</span><span class="p">;</span> 

  <span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>

    <p>stTimeout_t 封装了 Timeout 结构体。pItems 是一个链表数组，具体用法可以查看 <code class="highlighter-rouge">int AddTimeout( stTimeout_t *apTimeout,stTimeoutItem_t *apItem ,unsigned long long allNow )</code> 函数。</p>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>  <span class="k">struct</span> <span class="n">stTimeout_t</span>
  <span class="p">{</span>
      <span class="n">stTimeoutItemLink_t</span> <span class="o">*</span><span class="n">pItems</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">iItemSize</span><span class="p">;</span>
      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">ullStart</span><span class="p">;</span>
      <span class="kt">long</span> <span class="kt">long</span> <span class="n">llStartIdx</span><span class="p">;</span>
  <span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>hooking IO</p>

    <p>下面以 read 函数为例子，看看 libco 是如何将 io 操作通过 epoll 来管理并与协程结合起来。</p>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
</pre></td><td class="rouge-code"><pre>  <span class="kt">ssize_t</span> <span class="nf">read</span><span class="p">(</span> <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">nbyte</span> <span class="p">)</span>
  <span class="p">{</span>
      <span class="n">HOOK_SYS_FUNC</span><span class="p">(</span> <span class="n">read</span> <span class="p">);</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">co_is_enable_sys_hook</span><span class="p">()</span> <span class="p">)</span>  <span class="c1">// 如果没开启hook，则返回系统的 read 函数
</span>      <span class="p">{</span>
          <span class="k">return</span> <span class="n">g_sys_read_func</span><span class="p">(</span> <span class="n">fd</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">nbyte</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="n">rpchook_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">get_by_fd</span><span class="p">(</span> <span class="n">fd</span> <span class="p">);</span>

      <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">lp</span> <span class="o">||</span> <span class="p">(</span> <span class="n">O_NONBLOCK</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">user_flag</span> <span class="p">)</span> <span class="p">)</span> 
      <span class="p">{</span>
          <span class="kt">ssize_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">g_sys_read_func</span><span class="p">(</span> <span class="n">fd</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">nbyte</span> <span class="p">);</span>
          <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="kt">int</span> <span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">read_timeout</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="mi">1000</span> <span class="p">)</span> 
                  <span class="o">+</span> <span class="p">(</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">read_timeout</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">/</span> <span class="mi">1000</span> <span class="p">);</span>

      <span class="k">struct</span> <span class="n">pollfd</span> <span class="n">pf</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
      <span class="n">pf</span><span class="p">.</span><span class="n">fd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">;</span>
      <span class="n">pf</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="p">(</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLERR</span> <span class="o">|</span> <span class="n">POLLHUP</span> <span class="p">);</span>

      <span class="kt">int</span> <span class="n">pollret</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">pf</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">timeout</span> <span class="p">);</span>  <span class="c1">// 这里调用 poll 了，注意 poll 会挂起当前协程让出cpu，下面的指令需要等到该协程 resume 才会继续执行了。
</span>
      <span class="kt">ssize_t</span> <span class="n">readret</span> <span class="o">=</span> <span class="n">g_sys_read_func</span><span class="p">(</span> <span class="n">fd</span><span class="p">,(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="p">,</span><span class="n">nbyte</span> <span class="p">);</span>
		
      <span class="k">return</span> <span class="n">readret</span><span class="p">;</span>
		
  <span class="p">}</span>

  <span class="kt">int</span> <span class="nf">poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">pollfd</span> <span class="n">fds</span><span class="p">[],</span> <span class="n">nfds_t</span> <span class="n">nfds</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
  <span class="p">{</span>

      <span class="n">HOOK_SYS_FUNC</span><span class="p">(</span> <span class="n">poll</span> <span class="p">);</span>

      <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">co_is_enable_sys_hook</span><span class="p">()</span> <span class="p">)</span>
      <span class="p">{</span>
          <span class="k">return</span> <span class="n">g_sys_poll_func</span><span class="p">(</span> <span class="n">fds</span><span class="p">,</span><span class="n">nfds</span><span class="p">,</span><span class="n">timeout</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="n">co_poll</span><span class="p">(</span> <span class="n">co_get_epoll_ct</span><span class="p">(),</span><span class="n">fds</span><span class="p">,</span><span class="n">nfds</span><span class="p">,</span><span class="n">timeout</span> <span class="p">);</span>  <span class="c1">// 调用的是 co_poll
</span>  <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>epoll 逻辑</p>

    <p>最主要的代码都在 co_poll 函数和 co_eventloop 函数。</p>

    <div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
</pre></td><td class="rouge-code"><pre>  <span class="kt">int</span> <span class="nf">co_poll</span><span class="p">(</span> <span class="n">stCoEpoll_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="k">struct</span> <span class="n">pollfd</span> <span class="n">fds</span><span class="p">[],</span> <span class="n">nfds_t</span> <span class="n">nfds</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span> <span class="p">)</span>
  <span class="p">{</span>
      <span class="kt">int</span> <span class="n">epfd</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">iEpollFd</span><span class="p">;</span>

      <span class="c1">//1.struct change
</span>      <span class="n">stPoll_t</span> <span class="n">arg</span><span class="p">;</span>
      <span class="n">memset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">);</span>

      <span class="n">arg</span><span class="p">.</span><span class="n">iEpollFd</span> <span class="o">=</span> <span class="n">epfd</span><span class="p">;</span>
      <span class="n">arg</span><span class="p">.</span><span class="n">fds</span> <span class="o">=</span> <span class="n">fds</span><span class="p">;</span>
      <span class="n">arg</span><span class="p">.</span><span class="n">nfds</span> <span class="o">=</span> <span class="n">nfds</span><span class="p">;</span>

      <span class="n">stPollItem_t</span> <span class="n">arr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
      <span class="k">if</span><span class="p">(</span> <span class="n">nfds</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span>
      <span class="p">{</span>
          <span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span> <span class="o">=</span> <span class="n">arr</span><span class="p">;</span>
      <span class="p">}</span>	
      <span class="k">else</span>
      <span class="p">{</span>
          <span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span> <span class="o">=</span> <span class="p">(</span><span class="n">stPollItem_t</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span> <span class="n">nfds</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span> <span class="n">stPollItem_t</span> <span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="n">memset</span><span class="p">(</span> <span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nfds</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stPollItem_t</span><span class="p">)</span> <span class="p">);</span>

      <span class="n">arg</span><span class="p">.</span><span class="n">pfnProcess</span> <span class="o">=</span> <span class="n">OnPollProcessEvent</span><span class="p">;</span>  <span class="c1">// 当 epoll 事件被触发，就会调用该函数来 resume 相应的协程。
</span>      <span class="n">arg</span><span class="p">.</span><span class="n">pArg</span> <span class="o">=</span> <span class="n">GetCurrCo</span><span class="p">(</span> <span class="n">co_get_curr_thread_env</span><span class="p">()</span> <span class="p">);</span>  <span class="c1">// pArg 保存当前的协程，pfnProcess 函数中用该字段来得到需要 resume 的协程对象。
</span>		
      <span class="c1">//2.add timeout
</span>
      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">GetTickMS</span><span class="p">();</span>
      <span class="n">arg</span><span class="p">.</span><span class="n">ullExpireTime</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">;</span>
      <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">AddTimeout</span><span class="p">(</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pTimeout</span><span class="p">,</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">,</span><span class="n">now</span> <span class="p">);</span>  <span class="c1">// 调用 AddTimeout，由 stCoEpoll_t 管理超时。
</span>		
      <span class="c1">//3. add epoll
</span>
      <span class="k">for</span><span class="p">(</span><span class="n">nfds_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nfds</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pSelf</span> <span class="o">=</span> <span class="n">fds</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
          <span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pPoll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="p">;</span>

          <span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pfnPrepare</span> <span class="o">=</span> <span class="n">OnPollPreparePfn</span><span class="p">;</span>
          <span class="k">struct</span> <span class="n">epoll_event</span> <span class="o">&amp;</span><span class="n">ev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stEvent</span><span class="p">;</span>

          <span class="k">if</span><span class="p">(</span> <span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
          <span class="p">{</span>
              <span class="n">ev</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
              <span class="n">ev</span><span class="p">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">PollEvent2Epoll</span><span class="p">(</span> <span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span> <span class="p">);</span>

              <span class="n">co_epoll_ctl</span><span class="p">(</span> <span class="n">epfd</span><span class="p">,</span><span class="n">EPOLL_CTL_ADD</span><span class="p">,</span> <span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span> <span class="p">);</span>  <span class="c1">// 添加到 epoll 中监听
</span>          <span class="p">}</span>
          <span class="c1">//if fail,the timeout would work
</span>			
      <span class="p">}</span>

      <span class="n">co_yield_env</span><span class="p">(</span> <span class="n">co_get_curr_thread_env</span><span class="p">()</span> <span class="p">);</span>  <span class="c1">// 让出 cpu，挂起当前协程了。等到 stCoEpoll_t resume 该协程再继续执行下面的指令了
</span>
      <span class="c1">// 下面都是清理工作 可以不用细看
</span>      <span class="n">RemoveFromLink</span><span class="o">&lt;</span><span class="n">stTimeoutItem_t</span><span class="p">,</span><span class="n">stTimeoutItemLink_t</span><span class="o">&gt;</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">arg</span> <span class="p">);</span>
      <span class="k">for</span><span class="p">(</span><span class="n">nfds_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">nfds</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
      <span class="p">{</span>
          <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">fds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">;</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">fd</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
          <span class="p">{</span>
              <span class="n">co_epoll_ctl</span><span class="p">(</span> <span class="n">epfd</span><span class="p">,</span><span class="n">EPOLL_CTL_DEL</span><span class="p">,</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stEvent</span> <span class="p">);</span>
          <span class="p">}</span>
      <span class="p">}</span>


      <span class="k">if</span><span class="p">(</span> <span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span> <span class="o">!=</span> <span class="n">arr</span> <span class="p">)</span>
      <span class="p">{</span>
          <span class="n">free</span><span class="p">(</span> <span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span> <span class="p">);</span>
          <span class="n">arg</span><span class="p">.</span><span class="n">pPollItems</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="n">arg</span><span class="p">.</span><span class="n">iRaiseCnt</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// 事件循环
</span>  <span class="kt">void</span> <span class="nf">co_eventloop</span><span class="p">(</span> <span class="n">stCoEpoll_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="n">pfn_co_eventloop_t</span> <span class="n">pfn</span><span class="p">,</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span> <span class="p">)</span>
  <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">result</span> <span class="p">)</span>
      <span class="p">{</span>
          <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">result</span> <span class="o">=</span>  <span class="n">co_epoll_res_alloc</span><span class="p">(</span> <span class="n">stCoEpoll_t</span><span class="o">::</span><span class="n">_EPOLL_SIZE</span> <span class="p">);</span>
      <span class="p">}</span>
      <span class="n">co_epoll_res</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">result</span><span class="p">;</span>

      <span class="k">for</span><span class="p">(;;)</span>
      <span class="p">{</span>
          <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">co_epoll_wait</span><span class="p">(</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">iEpollFd</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">stCoEpoll_t</span><span class="o">::</span><span class="n">_EPOLL_SIZE</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

          <span class="n">stTimeoutItemLink_t</span> <span class="o">*</span><span class="n">active</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pstActiveList</span><span class="p">);</span>
          <span class="n">stTimeoutItemLink_t</span> <span class="o">*</span><span class="n">timeout</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pstTimeoutList</span><span class="p">);</span>

          <span class="n">memset</span><span class="p">(</span> <span class="n">timeout</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">stTimeoutItemLink_t</span><span class="p">)</span> <span class="p">);</span>

          <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ret</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
          <span class="p">{</span>
              <span class="n">stTimeoutItem_t</span> <span class="o">*</span><span class="n">item</span> <span class="o">=</span> <span class="p">(</span><span class="n">stTimeoutItem_t</span><span class="o">*</span><span class="p">)</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">.</span><span class="n">ptr</span><span class="p">;</span>
              <span class="k">if</span><span class="p">(</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">pfnPrepare</span> <span class="p">)</span>
              <span class="p">{</span>
                  <span class="n">item</span><span class="o">-&gt;</span><span class="n">pfnPrepare</span><span class="p">(</span> <span class="n">item</span><span class="p">,</span><span class="n">result</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">active</span> <span class="p">);</span>
              <span class="p">}</span>
              <span class="k">else</span>
              <span class="p">{</span>
                  <span class="n">AddTail</span><span class="p">(</span> <span class="n">active</span><span class="p">,</span><span class="n">item</span> <span class="p">);</span>  <span class="c1">// 监听到的事件放到 active 链表里
</span>              <span class="p">}</span>
          <span class="p">}</span>


          <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">GetTickMS</span><span class="p">();</span>
          <span class="n">TakeAllTimeout</span><span class="p">(</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pTimeout</span><span class="p">,</span><span class="n">now</span><span class="p">,</span><span class="n">timeout</span> <span class="p">);</span>  <span class="c1">// 超时的事件放到 timeout 链表里
</span>
          <span class="n">stTimeoutItem_t</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">timeout</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
          <span class="k">while</span><span class="p">(</span> <span class="n">lp</span> <span class="p">)</span>
          <span class="p">{</span>
              <span class="n">lp</span><span class="o">-&gt;</span><span class="n">bTimeout</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
              <span class="n">lp</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pNext</span><span class="p">;</span>
          <span class="p">}</span>

          <span class="n">Join</span><span class="o">&lt;</span><span class="n">stTimeoutItem_t</span><span class="p">,</span><span class="n">stTimeoutItemLink_t</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">active</span><span class="p">,</span><span class="n">timeout</span> <span class="p">);</span>  <span class="c1">// 合并 active 和 timeout 链表
</span>
          <span class="n">lp</span> <span class="o">=</span> <span class="n">active</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
          <span class="k">while</span><span class="p">(</span> <span class="n">lp</span> <span class="p">)</span>
          <span class="p">{</span>
              <span class="n">PopHead</span><span class="o">&lt;</span><span class="n">stTimeoutItem_t</span><span class="p">,</span><span class="n">stTimeoutItemLink_t</span><span class="o">&gt;</span><span class="p">(</span> <span class="n">active</span> <span class="p">);</span>
              <span class="k">if</span><span class="p">(</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pfnProcess</span> <span class="p">)</span>
              <span class="p">{</span>
                  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">pfnProcess</span><span class="p">(</span> <span class="n">lp</span> <span class="p">);</span>  <span class="c1">// 一个个拿出来处理，调用 pfnProcess 函数，即 OnPollProcessEvent 函数
</span>              <span class="p">}</span>
              <span class="n">lp</span> <span class="o">=</span> <span class="n">active</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">if</span><span class="p">(</span> <span class="n">pfn</span> <span class="p">)</span>
          <span class="p">{</span>
              <span class="k">if</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">pfn</span><span class="p">(</span> <span class="n">arg</span> <span class="p">)</span> <span class="p">)</span>
              <span class="p">{</span>
                  <span class="k">break</span><span class="p">;</span>
              <span class="p">}</span>
          <span class="p">}</span>
      <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="nf">OnPollProcessEvent</span><span class="p">(</span> <span class="n">stTimeoutItem_t</span> <span class="o">*</span> <span class="n">ap</span> <span class="p">)</span>
  <span class="p">{</span>
      <span class="n">stCoRoutine_t</span> <span class="o">*</span><span class="n">co</span> <span class="o">=</span> <span class="p">(</span><span class="n">stCoRoutine_t</span><span class="o">*</span><span class="p">)</span><span class="n">ap</span><span class="o">-&gt;</span><span class="n">pArg</span><span class="p">;</span>  <span class="c1">// 从上面知道，pArg 保存了该事件对应的协程
</span>      <span class="n">co_resume</span><span class="p">(</span> <span class="n">co</span> <span class="p">);</span>   <span class="c1">// resume 相应的协程
</span>  <span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>协程的挂起和恢复</p>

    <p>协程的挂起和恢复由 stCoRoutineEnv_t 的 pCallStack 来管理。</p>

    <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre>  void co_yield_env( stCoRoutineEnv_t *env )  // 挂起当前协程，恢复其父协程
  {
      stCoRoutine_t *last = env-&gt;pCallStack[ env-&gt;iCallStackSize - 2 ];  // last 可以认为是父协程
      stCoRoutine_t *curr = env-&gt;pCallStack[ env-&gt;iCallStackSize - 1 ];  // curr 为当前执行的协程
      env-&gt;iCallStackSize--;
      coctx_swap( &amp;curr-&gt;ctx, &amp;last-&gt;ctx );  // 保持 curr 协程的上下文， 并恢复 last 协程的上下文
  }

  void co_resume( stCoRoutine_t *co )   // 恢复 co 协程
  {
      stCoRoutineEnv_t *env = co-&gt;env;
      stCoRoutine_t *lpCurrRoutine = env-&gt;pCallStack[ env-&gt;iCallStackSize - 1 ];
      if( !co-&gt;cStart )
      {
          coctx_make( &amp;co-&gt;ctx,(coctx_pfn_t)CoRoutineFunc,co,0 );
          co-&gt;cStart = 1;
      }
      env-&gt;pCallStack[ env-&gt;iCallStackSize++ ] = co;  // 执行协程的时候压入 pCallStack 栈中
      coctx_swap( &amp;(lpCurrRoutine-&gt;ctx),&amp;(co-&gt;ctx) );  // 恢复 co 协程的上下文
  }
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<h2 id="流程图">流程图</h2>
<p>简化版的流程如下图所示：
<img src="/assets/images/learn-libco/illustration-1.png" width="800" /></p>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2016/09/03/talk-about-protobuf/" data-toggle="tooltip" data-placement="top" title="Protobuf 编码原理">
                        Previous<br>
                        <span>Protobuf 编码原理</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2016/10/13/libuv-source-code/" data-toggle="tooltip" data-placement="top" title="Libuv 源码阅读">
                        Next<br>
                        <span>Libuv 源码阅读</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        </a>
        
        
                <a data-sort="0058" 
                    href="/archive/?tag=%E4%B8%AA%E4%BA%BA%E9%A1%B9%E7%9B%AE"
                    title="个人项目"
                    rel="4">个人项目</a>
        
                <a data-sort="0040" 
                    href="/archive/?tag=%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0"
                    title="读书笔记"
                    rel="22">读书笔记</a>
        
                <a data-sort="0047" 
                    href="/archive/?tag=%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"
                    title="源码阅读"
                    rel="15">源码阅读</a>
        
                <a data-sort="0055" 
                    href="/archive/?tag=%E5%B7%A5%E4%BD%9C"
                    title="工作"
                    rel="7">工作</a>
        
                <a data-sort="0059" 
                    href="/archive/?tag=%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80"
                    title="编程语言"
                    rel="3">编程语言</a>
        
                <a data-sort="0059" 
                    href="/archive/?tag=%E9%9A%8F%E7%AC%94"
                    title="随笔"
                    rel="3">随笔</a>
        
                <a data-sort="0060" 
                    href="/archive/?tag=%E4%BC%98%E5%8C%96%26%E9%87%8D%E6%9E%84"
                    title="优化&重构"
                    rel="2">优化&重构</a>
        
                <a data-sort="0060" 
                    href="/archive/?tag=%E6%95%B0%E6%8D%AE%E5%BA%93"
                    title="数据库"
                    rel="2">数据库
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="https://blog.zhiheng.io">onlyice</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  
  
  
  <li>
    <a target="_blank" href="https://github.com/masutangu">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  
  <li>
    <a target="_blank" href="https://www.instagram.com/masutanguu">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Masutangu 2018
                    <br>
                    Powered by <a href="http://huangxuan.me">Hux Blog</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->





<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-77236140-1';
    var _gaDomain = 'masutangu.com';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->



<!-- Multi-Lingual -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
