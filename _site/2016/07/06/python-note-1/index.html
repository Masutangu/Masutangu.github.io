<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="关于程序与设计、黑客与画家  这里是 Masutangu 的个人博客。">
    <meta name="keywords"  content="Masutangu, Masutangu 的博客, Masutangu Blog, 博客, 个人网站, 互联网, 后端, Python, Go, C++">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="Python 笔记 - Masutangu 的博客 | Masutangu Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="这篇文章整理了python相关的资料，包括性能优化、常见错误和高级用法。

">
    
    <meta property="article:published_time" content="2016-07-06T18:56:31Z">
    
    
    
    <meta property="article:tag" content="编程语言">
    
    
    <meta property="og:image" content="http://localhost:4000/img/avatar.jpg">
    <meta property="og:url" content="http://localhost:4000/2016/07/06/python-note-1/">
    <meta property="og:site_name" content="Masutangu 的博客 | Masutangu Blog">
    
    <title>Python 笔记 - Masutangu 的博客 | Masutangu Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2016/07/06/python-note-1/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Masutangu</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">主页</a>
                    </li>
                    
                    
                    
                    
                    <li>
                        <a href="/about/">关于</a>
                    </li>
                    
                    
                    
                    <li>
                        <a href="/archive/">归档</a>
                    </li>
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    var __HuxNav__ = {
        close: function(){
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        },
        open: function(){
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }

    // Bind Event
    $toggle.addEventListener('click', function(e){
        if ($navbar.className.indexOf('in') > 0) {
            __HuxNav__.close()
        }else{
            __HuxNav__.open()
        }
    })

    /**
     * Since Fastclick is used to delegate 'touchstart' globally
     * to hack 300ms delay in iOS by performing a fake 'click',
     * Using 'e.stopPropagation' to stop 'touchstart' event from 
     * $toggle/$collapse will break global delegation.
     * 
     * Instead, we use a 'e.target' filter to prevent handler
     * added to document close HuxNav.  
     *
     * Also, we use 'click' instead of 'touchstart' as compromise
     */
    document.addEventListener('click', function(e){
        if(e.target == $toggle) return;
        if(e.target.className == 'icon-bar') return;
        __HuxNav__.close();
    })
</script>


    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg.jpg');
        background: ;
    }

    
</style>

<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                        <a class="tag" href="/archive/?tag=%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80" title="编程语言">编程语言</a>
                        
                    </div>
                    <h1>Python 笔记</h1>
                    
                    <h2 class="subheading"></h2>
                    <span class="meta">Posted by Masutangu on July 6, 2016</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<p>这篇文章整理了python相关的资料，包括性能优化、常见错误和高级用法。</p>

<p><em>注：本文内容整理自网上博客，《Python Cookbook》等，非原创。</em></p>

<h2 id="性能优化">性能优化</h2>
<h3 id="1-字典和列表">1. 字典和列表</h3>

<p>Python 字典中使用了 hash table，因此查找操作的复杂度为 O(1)，而 list 实际是个数组，在 list 中，查找需要遍历整个 list，其复杂度为 O(n)，因此对成员的查找访问等操作字典要比 list 更快。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s">'a'</span><span class="p">,</span><span class="s">'b'</span><span class="p">,</span><span class="s">'is'</span><span class="p">,</span><span class="s">'python'</span><span class="p">,</span><span class="s">'jason'</span><span class="p">,</span><span class="s">'hello'</span><span class="p">,</span><span class="s">'hill'</span><span class="p">,</span><span class="s">'with'</span><span class="p">,</span><span class="s">'phone'</span><span class="p">,</span><span class="s">'test'</span><span class="p">,</span>
<span class="s">'dfdf'</span><span class="p">,</span><span class="s">'apple'</span><span class="p">,</span><span class="s">'pddf'</span><span class="p">,</span><span class="s">'ind'</span><span class="p">,</span><span class="s">'basic'</span><span class="p">,</span><span class="s">'none'</span><span class="p">,</span><span class="s">'baecr'</span><span class="p">,</span><span class="s">'var'</span><span class="p">,</span><span class="s">'bana'</span><span class="p">,</span><span class="s">'dd'</span><span class="p">,</span><span class="s">'wrd'</span><span class="p">]</span>
<span class="c">#list = dict.fromkeys(list,True)</span>
<span class="k">print</span> <span class="nb">list</span>
<span class="nb">filter</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">find</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'is'</span><span class="p">,</span><span class="s">'hat'</span><span class="p">,</span><span class="s">'new'</span><span class="p">,</span><span class="s">'list'</span><span class="p">,</span><span class="s">'old'</span><span class="p">,</span><span class="s">'.'</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">find</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
            <span class="nb">filter</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">find</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"total run time:"</span>
<span class="k">print</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>将list转化为dict后速度提升了将近一半。</p>

<h3 id="2-集合和列表">2. 集合和列表</h3>
<p>set 的 union， intersection，difference 操作要比 list 的迭代要快。因此如果涉及到求 list 交集，并集或者差的问题可以转换为 set 来操作。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre></td><td class="rouge-code"><pre><span class="c"># 使用list：</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">lista</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">44</span><span class="p">]</span>
<span class="n">listb</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">23</span><span class="p">]</span>
<span class="n">intersection</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
<span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">lista</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">listb</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">:</span>
            <span class="n">intersection</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"total run time:"</span>
<span class="k">print</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

<span class="c"># 使用set：</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="n">lista</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">13</span><span class="p">,</span><span class="mi">34</span><span class="p">,</span><span class="mi">53</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="mi">44</span><span class="p">]</span>
<span class="n">listb</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">23</span><span class="p">]</span>
<span class="n">intersection</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
    <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">lista</span><span class="p">)</span><span class="o">&amp;</span><span class="nb">set</span><span class="p">(</span><span class="n">listb</span><span class="p">))</span>
<span class="k">print</span> <span class="s">"total run time:"</span>
<span class="k">print</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="3-字符串的优化">3. 字符串的优化</h3>
<ul>
  <li>在字符串连接的使用尽量使用 join() 而不是 +。</li>
  <li>当对字符串可以使用正则表达式或者内置函数来处理的时候，选择内置函数。如 str.isalpha()，str.isdigit()，str.startswith((‘x’, ‘yz’))，str.endswith((‘x’, ‘yz’))</li>
  <li>
    <p>对字符进行格式化比直接串联读取要快，因此要</p>

    <p>使用：<code class="highlighter-rouge">out = "<span class="nt">&lt;html&gt;</span>%s%s%s%s<span class="nt">&lt;/html&gt;</span>" % (head, prologue, query, tail)</code></p>

    <p>避免：<code class="highlighter-rouge">out = "<span class="nt">&lt;html&gt;</span>" + head + prologue + query + tail + "<span class="nt">&lt;/html&gt;</span>"</code></p>
  </li>
</ul>

<h3 id="4-使用列表解析和生成器表达式">4. 使用列表解析和生成器表达式</h3>
<p>列表解析要比在循环中重新构建一个新的 list 更为高效，因此我们可以利用这一特性来提高运行的效率。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">time</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="p">()</span>
<span class="nb">list</span> <span class="o">=</span> <span class="p">[</span><span class="s">'a'</span><span class="p">,</span><span class="s">'b'</span><span class="p">,</span><span class="s">'is'</span><span class="p">,</span><span class="s">'python'</span><span class="p">,</span><span class="s">'jason'</span><span class="p">,</span><span class="s">'hello'</span><span class="p">,</span><span class="s">'hill'</span><span class="p">,</span><span class="s">'with'</span><span class="p">,</span><span class="s">'phone'</span><span class="p">,</span><span class="s">'test'</span><span class="p">,</span>
<span class="s">'dfdf'</span><span class="p">,</span><span class="s">'apple'</span><span class="p">,</span><span class="s">'pddf'</span><span class="p">,</span><span class="s">'ind'</span><span class="p">,</span><span class="s">'basic'</span><span class="p">,</span><span class="s">'none'</span><span class="p">,</span><span class="s">'baecr'</span><span class="p">,</span><span class="s">'var'</span><span class="p">,</span><span class="s">'bana'</span><span class="p">,</span><span class="s">'dd'</span><span class="p">,</span><span class="s">'wrd'</span><span class="p">]</span>
<span class="n">total</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
<span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">:</span>
    <span class="n">total</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="k">print</span> <span class="s">"total run time:"</span>
<span class="k">print</span> <span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">t</span>

<span class="c"># 使用列表解析：</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>在上述例子上中代码 <code class="highlighter-rouge">a = [w for w in list]</code> 修改为 <code class="highlighter-rouge">a = (w for w in list)</code>，运行时间将进一步减少。</p>

<h3 id="5-其他优化技巧">5. 其他优化技巧</h3>
<ul>
  <li>如果需要交换两个变量的值使用 a,b=b,a 而不是借助中间变量 t=a;a=b;b=t；</li>
  <li>在循环的时候使用 xrange 而不是 range；使用 xrange 可以节省大量的系统内存，因为 xrange() 在序列中每次调用只产生一个整数元素。而 range() 將直接返回完整的元素列表，用于循环时会有不必要的开销。在 python3 中 xrange 不再存在，里面 range 提供一个可以遍历任意长度的范围的 iterator。</li>
  <li>使用局部变量，避免”global” 关键字。python 访问局部变量会比全局变量要快得多，因 此可以利用这一特性提升性能。</li>
  <li>if done is not None 比语句 if done != None 更快，读者可以自行验证；</li>
  <li>在耗时较多的循环中，可以把函数的调用改为内联的方式；</li>
  <li>使用级联比较 “x &lt; y &lt; z” 而不是 “x &lt; y and y &lt; z”；</li>
  <li>while 1 要比 while True 更快（当然后者的可读性更好）；</li>
  <li>build in 函数通常较快，add(a,b) 要优于 a+b。</li>
</ul>

<h2 id="常见错误">常见错误</h2>
<h3 id="1-range的使用">1. range的使用</h3>

<p>不恰当的使用range，容易出bug：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">for</span> <span class="n">i</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alist</span><span class="p">)):</span>
    <span class="k">print</span> <span class="n">alist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>正确的做法：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">alist</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">item</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>不恰当使用range的理由：</p>

<ul>
  <li>
    <p>需要在循环中使用索引：</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>  <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">alist</span><span class="p">):</span>
      <span class="k">print</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>需要同时迭代两个循环：</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>  <span class="k">for</span> <span class="n">word</span><span class="p">,</span> <span class="n">number</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">words</span><span class="p">,</span> <span class="n">numbers</span><span class="p">):</span>
      <span class="k">print</span> <span class="n">word</span><span class="p">,</span> <span class="n">number</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>需要迭代序列的一部分：</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>  <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span> <span class="c"># 不包括第一个元素</span>
      <span class="k">print</span> <span class="n">word</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p><strong>range的正确用法是生成一个数字序列，而不是生成索引：</strong></p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre>  <span class="c"># Print foo(x) for 0&lt;=x&lt;5</span>
  <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
      <span class="k">print</span> <span class="n">foo</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
</ul>

<h3 id="2-变量泄漏">2. 变量泄漏</h3>
<ul>
  <li>
    <p>循环</p>

    <p>错误的代码：</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>  <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">max_value</span><span class="p">:</span>
          <span class="k">break</span>

  <span class="n">processList</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>当y为空，processList将会抛出异常，原因是idx没有定义。</p>

    <p>正确的处理方式：<strong>哨兵模式</strong>，在循环前为idx设置一些特殊的值。</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre>  <span class="n">idx</span> <span class="err">＝</span> <span class="bp">None</span>
  <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="n">max_value</span><span class="p">:</span>
          <span class="k">break</span>

  <span class="k">if</span> <span class="n">idex</span><span class="p">:</span>
      <span class="n">processList</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>外作用域</p>

    <p>错误的代码：</p>

    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre>  <span class="kn">import</span> <span class="nn">sys</span>

  <span class="c"># See the bug in the function declaration?</span>
  <span class="k">def</span> <span class="nf">print_file</span><span class="p">(</span><span class="n">filenam</span><span class="p">):</span>
      <span class="s">"""Print every line of a file."""</span>
      <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_file</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">input_file</span><span class="p">:</span>
              <span class="k">print</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

  <span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
      <span class="n">filename</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">print_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
    <p>此时函数定义中的参数被错误的写为filenam，但是程序依然可以运行。因为print_file的外部作用域存在一个filename的变量。</p>

    <p>正确的做法：<strong>外部作用域的全局变量命名要明显</strong>，例如IN_ALL_CAPS。</p>
  </li>
</ul>

<h3 id="3-循环的数据结构导致循环">3. 循环的数据结构导致循环</h3>

<p>如果在一个对象中发现一个循环，python会输出一个[…]。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">mylist</span> <span class="err">＝</span> <span class="err">［</span><span class="s">'test'</span><span class="p">]</span>
<span class="n">mylist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mylist</span><span class="p">)</span>
<span class="c">#此时会打印['test',[...]]</span>
<span class="k">print</span> <span class="n">mylist</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="4-赋值创建引用">4. 赋值创建引用</h3>

<p>python中赋值语句不会创建对象副本,只会创建引用：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
<span class="n">arr_cp</span> <span class="o">=</span> <span class="n">arr</span>
<span class="n">arr_cp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c">#print打印出[100, 2, 3, 4]</span>
<span class="k">print</span> <span class="n">arr</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="5-静态识别局部变量">5. 静态识别局部变量</h3>

<p>python默认将一个在函数中赋值的变量名视为局部变量，存在于该函数的作用域并当函数运行时才存在。python是在编译def代码时去静态识别局部变量的。</p>

<p>错误的代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">a</span> <span class="err">＝</span> <span class="mi">100</span>

<span class="err">＃你可能想先打印</span><span class="n">a</span><span class="err">的值，再对</span><span class="n">a</span><span class="err">的值进行修改</span>
<span class="k">def</span> <span class="nf">myfunc</span><span class="p">():</span>
    <span class="k">print</span> <span class="n">a</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">200</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>因为在预编译的时候python发现函数中对a有赋值，因此把a当作局部变量。而运行到‘print a’语句的时候，局部变量a尚未赋值，因此会报错。</p>

<p>正确的代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre><span class="n">a</span> <span class="err">＝</span> <span class="mi">100</span>

<span class="k">def</span> <span class="nf">myfunc</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">a</span>
    <span class="k">print</span> <span class="n">a</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mi">200</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>更隐晦的错误代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="n">myVar</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">myfunc</span><span class="p">():</span>
    <span class="n">myVar</span> <span class="o">+=</span> <span class="mi">1</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p><code class="highlighter-rouge">myVar += 1</code>其实相当于<code class="highlighter-rouge">myVar = myVar + 1</code>，python检测到myVar变量有赋值操作，因此将myVar添加到局部命名空间中。当执行到<code class="highlighter-rouge">myVar += 1</code>时会读取myVar的值，此时该变量尚未有值关联，因此会报错。</p>

<h3 id="6-默认参数">6. 默认参数</h3>

<p>在执行def语句时，默认参数的值只被解析并保存一次。因此在修改可变的默认变量时可能会出现意想不到的效果。</p>

<p>错误的代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">saver</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">x</span>

<span class="n">saver</span><span class="p">()</span> <span class="c"># 打印[1]</span>
<span class="n">saver</span><span class="p">()</span> <span class="c"># 打印[1,1]</span>
<span class="n">saver</span><span class="p">()</span> <span class="c"># 打印[1,1,1]</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>因为默认参数只被解析并保存一次。因此可变的默认参数在每次函数调用都会保存状态。</p>

<p>正确的代码：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">saver</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">x</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>def是python中的可执行语句。默认参数在def的语句环境里被计算。如果你执行了def语句多次，每次它都将会创建一个新的函数对象。</p>

<p>看看stackoverflow的一个例子：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre><span class="n">flist</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span> <span class="o">*</span> <span class="n">i</span>
    <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="err">＃</span><span class="n">expect</span> <span class="mi">0</span> <span class="mi">2</span> <span class="mi">4</span> <span class="n">but</span> <span class="k">print</span> <span class="mi">4</span> <span class="mi">4</span> <span class="mi">4</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>我们可以借助默认参数的机制，在执行def时解析默认参数的值：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="n">flist</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">):</span> <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">i</span>
    <span class="n">flist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">flist</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">f</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>默认参数还可以用来做缓存：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">calculate</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">memo</span><span class="o">=</span><span class="p">{}):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">memo</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="c"># return already calculated value</span>
    <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">heavy_calculation</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
    <span class="n">memo</span><span class="p">[</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="c"># update the memo dictionary</span>
    <span class="k">return</span> <span class="n">value</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>牢记：当Python执行一条def语句时， 它会使用已经准备好的东西（包括函数的代码对象和函数的上下文属性），创建了一个新的函数对象。同时，计算了函数的默认参数值。</p>

<h3 id="7-谨慎使用super">7. 谨慎使用super()</h3>

<p>原文<a href="https://fuhm.net/super-harmful/">Python’s Super is nifty, but you can’t use it</a></p>

<p>作者提出两个观点：</p>

<ul>
  <li>People omit calls to super(…).<strong>init</strong> if the only superclass is ‘object’, as, after all, object.<strong>init</strong> doesn’t do anything! However, this is very incorrect. Doing so will cause other classes’ <strong>init</strong> methods to not be called.</li>
  <li>People think they know what arguments their method will get, and what arguments they should pass along to super. This is also incorrect.
先看第二点，比较好理解，代码如下：</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"A"</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"B"</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"C"</span><span class="p">,</span><span class="s">"arg="</span><span class="p">,</span><span class="n">arg</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">D</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"D"</span><span class="p">,</span> <span class="s">"arg="</span><span class="p">,</span><span class="n">arg</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">E</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">D</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"E"</span><span class="p">,</span> <span class="s">"arg="</span><span class="p">,</span><span class="n">arg</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"MRO:"</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">__name__</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">E</span><span class="o">.</span><span class="n">__mro__</span><span class="p">]</span>
<span class="n">E</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>看着很正确，执行下报错：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="n">MRO</span><span class="p">:</span> <span class="p">[</span><span class="s">'E'</span><span class="p">,</span> <span class="s">'C'</span><span class="p">,</span> <span class="s">'A'</span><span class="p">,</span> <span class="s">'D'</span><span class="p">,</span> <span class="s">'B'</span><span class="p">,</span> <span class="s">'object'</span><span class="p">]</span>
<span class="n">E</span> <span class="n">arg</span><span class="o">=</span> <span class="mi">10</span>
<span class="n">C</span> <span class="n">arg</span><span class="o">=</span> <span class="mi">10</span>
<span class="n">A</span>

<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="n">File</span> <span class="s">"C:</span><span class="err">\</span><span class="s">Users</span><span class="err">\</span><span class="s">mustangmo</span><span class="err">\</span><span class="s">Desktop</span><span class="se">\t</span><span class="s">est1.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">27</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">E</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">File</span> <span class="s">"C:</span><span class="err">\</span><span class="s">Users</span><span class="err">\</span><span class="s">mustangmo</span><span class="err">\</span><span class="s">Desktop</span><span class="se">\t</span><span class="s">est1.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">24</span><span class="p">,</span> <span class="ow">in</span> <span class="n">__init__</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
<span class="n">File</span> <span class="s">"C:</span><span class="err">\</span><span class="s">Users</span><span class="err">\</span><span class="s">mustangmo</span><span class="err">\</span><span class="s">Desktop</span><span class="se">\t</span><span class="s">est1.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">14</span><span class="p">,</span> <span class="ow">in</span> <span class="n">__init__</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
<span class="n">File</span> <span class="s">"C:</span><span class="err">\</span><span class="s">Users</span><span class="err">\</span><span class="s">mustangmo</span><span class="err">\</span><span class="s">Desktop</span><span class="se">\t</span><span class="s">est1.py"</span><span class="p">,</span> <span class="n">line</span> <span class="mi">4</span><span class="p">,</span> <span class="ow">in</span> <span class="n">__init__</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
<span class="nb">TypeError</span><span class="p">:</span> <span class="n">__init__</span><span class="p">()</span> <span class="n">takes</span> <span class="n">exactly</span> <span class="mi">2</span> <span class="n">arguments</span> <span class="p">(</span><span class="mi">1</span> <span class="n">given</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>原因是：MRO: [‘E’, ‘C’, ‘A’, ‘D’, ‘B’, ‘object’]，A的下一个是D，因此super(A, self)方法调用的是D的__init__方法，D的__init__方法需要一个参数，因此报错了。</p>

<p>再看第一点，如果父类是object的话，不调用super().__init__可能会导致问题，例子如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"A"</span>
        <span class="c">#super(A, self).__init__(*args, **kwargs) 注释掉</span>

<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"B"</span>
        <span class="c">#super(B, self).__init__(*args, **kwargs) 注释掉</span>

<span class="k">class</span> <span class="nc">C</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"C"</span><span class="p">,</span><span class="s">"arg="</span><span class="p">,</span><span class="n">arg</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">D</span><span class="p">(</span><span class="n">B</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"D"</span><span class="p">,</span> <span class="s">"arg="</span><span class="p">,</span><span class="n">arg</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">E</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="n">D</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"E"</span><span class="p">,</span> <span class="s">"arg="</span><span class="p">,</span><span class="n">arg</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">E</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">print</span> <span class="s">"MRO:"</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">__name__</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">E</span><span class="o">.</span><span class="n">__mro__</span><span class="p">]</span>
<span class="n">E</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="sb">``</span><span class="err">`</span><span class="n">python</span>
<span class="err">输出结果：</span>

</pre></td></tr></tbody></table></code></pre></div></div>
<p>MRO: [‘E’, ‘C’, ‘A’, ‘D’, ‘B’, ‘object’]
E arg= 10
C arg= 10
A</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre>可以发现D和B都没有输出，也就是说如果没有调用父类为object类的super.__init__()，会导致其他类（在本例中为D和B）的__init__()不执行。按理来说，调用了类E的super.__init__()函数，应该会同时调用E的父类C和D的__init__()函数。但是由于MRO是以super()调用来驱动的，上诉例子中，执行到A时，由于没有调用super的init()函数了，因此整个链路就停了。
总结：

* 一定要调用父类为object的类的super.__init__()函数
* 调用的super()返回不一定是父类，因此super调用最好保持参数一致

另附一篇也是关于super的文章[Python’s super() considered super!](http://rhettinger.wordpress.com/2011/05/26/super-considered-super/)

### 8. string转换为dict

```python
str = ‘{ "key" : null}'
mydict = eval(str)
</pre></td></tr></tbody></table></code></pre></div></div>
<p>eval 可能会报错，因为 json 的语义跟 Python 的 dict 不完全一样, 如果 json 串里面出现一个 null 就报错了.
因此合适的方法是采用如下写法：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">()</span>
<span class="n">mydict</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h2 id="高级特性">高级特性</h2>

<h3 id="1-闭包">1. 闭包</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">return_func_that_prints_list</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
        <span class="k">print</span> <span class="n">z</span>
    <span class="k">return</span> <span class="n">f</span>

<span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">return_func_that_prints_list</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
<span class="n">g</span><span class="p">()</span>  <span class="c"># print [1, 2]</span>

<span class="n">z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">g</span><span class="p">()</span>  <span class="c"># print [1, 2, 3]</span>
<span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">g</span><span class="p">()</span>  <span class="c"># print [1, 2, 3]</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>【译者】：z.append(3)时，g()内部的引用和z仍然指向一个变量，而z=[1]之后，两者就不再指向一个变量了。</p>

<p>关于闭包，stack overflow http://stackoverflow.com/questions/4020419/closures-in-python</p>

<h3 id="2-wraps">2. wraps</h3>

<p><strong>给decorator加上wraps以保留原有函数的名称和docstring：</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="k">def</span> <span class="nf">my_decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">'Calling decorated function'</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>


<span class="nd">@my_decorator</span>
<span class="k">def</span> <span class="nf">example</span><span class="p">():</span>
    <span class="s">"""Docstring"""</span>
    <span class="k">print</span> <span class="s">'Called example function'</span>
    
<span class="n">example</span><span class="p">()</span>  <span class="c"># print 'Calling decorated function' 'Called example function'</span>
<span class="n">example</span><span class="o">.</span><span class="n">__name__</span>  <span class="c"># print 'example'</span>
<span class="n">example</span><span class="o">.</span><span class="n">__doc__</span>  <span class="c"># print 'Docstring'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><strong>Without the use of this decorator factory, the name of the example function would have been ‘wrapper’, and the docstring of the original example() would have been lost.</strong></p>

<h3 id="3-class-decorator">3. class decorator</h3>

<p><strong>给类的所有函数添加decorator：</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">logged</span><span class="p">(</span><span class="n">time_format</span><span class="p">,</span> <span class="n">name_prefix</span><span class="o">=</span><span class="s">""</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s">'_logged_decorator'</span><span class="p">)</span> <span class="ow">and</span> <span class="n">func</span><span class="o">.</span><span class="n">_logged_decorator</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span>

        <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">decorated_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">"- Running '</span><span class="si">%</span><span class="s">s' on </span><span class="si">%</span><span class="s">s "</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">name_prefix</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                                            <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">time_format</span><span class="p">)</span>
                                <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">"- Finished '</span><span class="si">%</span><span class="s">s', execution time = </span><span class="si">%0.3</span><span class="s">fs "</span> <span class="o">%</span> <span class="p">(</span>
                                            <span class="n">name_prefix</span> <span class="o">+</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                                            <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>
                                <span class="p">)</span>

            <span class="k">return</span> <span class="n">result</span>
        <span class="n">decorated_func</span><span class="o">.</span><span class="n">_logged_decorator</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">decorated_func</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="k">def</span> <span class="nf">log_method_calls</span><span class="p">(</span><span class="n">time_format</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">'__’): #过滤掉以双下划线开头的attributes</span><span class="err">
</span><span class="s">                continue</span><span class="err">
</span><span class="s">            a = getattr(cls, attr)</span><span class="err">
</span><span class="s">            if hasattr(a, '</span><span class="n">__call__</span><span class="err">’</span><span class="p">):</span> <span class="c">#如果包含__call__属性，说明是函数</span>
                <span class="n">decorated_a</span> <span class="o">=</span> <span class="n">logged</span><span class="p">(</span><span class="n">time_format</span><span class="p">,</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s">"."</span><span class="p">)(</span><span class="n">a</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">decorated_a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">cls</span>
    <span class="k">return</span> <span class="n">decorator</span>

<span class="nd">@log_method_calls</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">b </span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">Y - </span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M:</span><span class="si">%</span><span class="s">S"</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"test1"</span>

<span class="nd">@log_method_calls</span><span class="p">(</span><span class="s">"</span><span class="si">%</span><span class="s">b </span><span class="si">%</span><span class="s">d </span><span class="si">%</span><span class="s">Y - </span><span class="si">%</span><span class="s">H:</span><span class="si">%</span><span class="s">M:</span><span class="si">%</span><span class="s">S"</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">B</span><span class="p">(</span><span class="n">A</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">test1</span><span class="p">()</span>
        <span class="k">print</span> <span class="s">"child test1"</span>

    <span class="k">def</span> <span class="nf">test2</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">"test2"</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="n">b</span><span class="o">.</span><span class="n">test1</span><span class="p">()</span>
<span class="n">b</span><span class="o">.</span><span class="n">test2</span><span class="p">()</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>输出如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="rouge-code"><pre><span class="o">-</span> <span class="n">Running</span> <span class="s">'B.test1'</span> <span class="n">on</span> <span class="n">Jul</span> <span class="mi">24</span> <span class="mi">2013</span> <span class="o">-</span> <span class="mi">14</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mo">03</span>
<span class="o">-</span> <span class="n">Running</span> <span class="s">'A.test1'</span> <span class="n">on</span> <span class="n">Jul</span> <span class="mi">24</span> <span class="mi">2013</span> <span class="o">-</span> <span class="mi">14</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mo">03</span>
<span class="n">test1</span>
<span class="o">-</span> <span class="n">Finished</span> <span class="s">'A.test1'</span><span class="p">,</span> <span class="n">execution</span> <span class="n">time</span> <span class="o">=</span> <span class="mf">0.000</span><span class="n">s</span>
<span class="n">child</span> <span class="n">test1</span>
<span class="o">-</span> <span class="n">Finished</span> <span class="s">'B.test1'</span><span class="p">,</span> <span class="n">execution</span> <span class="n">time</span> <span class="o">=</span> <span class="mf">1.001</span><span class="n">s</span>
<span class="o">-</span> <span class="n">Running</span> <span class="s">'B.test2'</span> <span class="n">on</span> <span class="n">Jul</span> <span class="mi">24</span> <span class="mi">2013</span> <span class="o">-</span> <span class="mi">14</span><span class="p">:</span><span class="mi">15</span><span class="p">:</span><span class="mo">04</span>
<span class="n">test2</span>
<span class="o">-</span> <span class="n">Finished</span> <span class="s">'B.test2'</span><span class="p">,</span> <span class="n">execution</span> <span class="n">time</span> <span class="o">=</span> <span class="mf">2.001</span><span class="n">s</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="4-descriptor">4. descriptor</h3>

<ul>
  <li>用法1：Type Checking</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre></td><td class="rouge-code"><pre><span class="c"># Descriptor for a type-checked attribute</span>
<span class="k">class</span> <span class="nc">Typed</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">expected_type</span> <span class="o">=</span> <span class="n">expected_type</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_type</span><span class="p">):</span>
            <span class="k">raise</span> <span class="nb">TypeError</span><span class="p">(</span><span class="s">'Expected '</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_type</span><span class="p">))</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="nf">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">instance</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>


<span class="c"># Class decorator that applies it to selected attributes</span>
<span class="k">def</span> <span class="nf">typeassert</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">expected_type</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c"># Attach a Typed descriptor to the class</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Typed</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">expected_type</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">cls</span>
    <span class="k">return</span> <span class="n">decorate</span>

<span class="c"># Example use</span>
<span class="nd">@typeassert</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">shares</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">price</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Stock</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">shares</span><span class="p">,</span> <span class="n">price</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shares</span> <span class="o">=</span> <span class="n">shares</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">price</span> <span class="o">=</span> <span class="n">price</span>
</pre></td></tr></tbody></table></code></pre></div></div>
<p>Finally, it should be stressed that you would probably not write a descriptor if you simply want to customize the access of a single attribute of a specific class. Descriptors are more useful in situations where there will be a lot of code reuse (i.e., you want to use the functionality provided by the descriptor in hundreds of places in your code or provide it as a library feature).</p>

<ul>
  <li>用法2：Lazily Computed Properties</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">lazyproperty</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>If a descriptor only defines a <strong>get</strong>() method, it has a much weaker binding than usual. In particular, the <strong>get</strong>() method only fires if the attribute being accessed is not in the underlying instance dictionary.</p>


                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2016/07/04/matplot-note/" data-toggle="tooltip" data-placement="top" title="Matplotlib 笔记">
                        Previous<br>
                        <span>Matplotlib 笔记</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2016/07/07/elric-documentation/" data-toggle="tooltip" data-placement="top" title="Elric 使用手册">
                        Next<br>
                        <span>Elric 使用手册</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                

                
            </div>  

    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        </a>
        
        
                <a data-sort="0058" 
                    href="/archive/?tag=%E4%B8%AA%E4%BA%BA%E9%A1%B9%E7%9B%AE"
                    title="个人项目"
                    rel="4">个人项目</a>
        
                <a data-sort="0040" 
                    href="/archive/?tag=%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0"
                    title="读书笔记"
                    rel="22">读书笔记</a>
        
                <a data-sort="0047" 
                    href="/archive/?tag=%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB"
                    title="源码阅读"
                    rel="15">源码阅读</a>
        
                <a data-sort="0055" 
                    href="/archive/?tag=%E5%B7%A5%E4%BD%9C"
                    title="工作"
                    rel="7">工作</a>
        
                <a data-sort="0059" 
                    href="/archive/?tag=%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80"
                    title="编程语言"
                    rel="3">编程语言</a>
        
                <a data-sort="0059" 
                    href="/archive/?tag=%E9%9A%8F%E7%AC%94"
                    title="随笔"
                    rel="3">随笔</a>
        
                <a data-sort="0060" 
                    href="/archive/?tag=%E4%BC%98%E5%8C%96%26%E9%87%8D%E6%9E%84"
                    title="优化&重构"
                    rel="2">优化&重构</a>
        
                <a data-sort="0060" 
                    href="/archive/?tag=%E6%95%B0%E6%8D%AE%E5%BA%93"
                    title="数据库"
                    rel="2">数据库
    </div>
</section>


                <!-- Friends Blog -->
                
<hr>
<h5>FRIENDS</h5>
<ul class="list-inline">
  
  <li><a href="https://blog.zhiheng.io">onlyice</a></li>
  
</ul>

            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->









<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'always',
          placement: 'right',
          icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  
  
  
  <li>
    <a target="_blank" href="https://github.com/masutangu">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
  
  
  <li>
    <a target="_blank" href="https://www.instagram.com/masutanguu">
      <span class="fa-stack fa-lg">
        <i class="fa fa-circle fa-stack-2x"></i>
        <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
      </span>
    </a>
  </li>
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; Masutangu 2018
                    <br>
                    Powered by <a href="http://huangxuan.me">Hux Blog</a>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->





<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->

<script>
    // dynamic User by Hux
    var _gaId = 'UA-77236140-1';
    var _gaDomain = 'masutangu.com';

    // Originial
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', _gaId, _gaDomain);
    ga('send', 'pageview');
</script>



<!-- Baidu Tongji -->



<!-- Side Catalog -->



<!-- Multi-Lingual -->




<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
